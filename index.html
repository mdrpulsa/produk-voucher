<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Produk - MDR STORE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@600&family=Nunito:wght@400;700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Nunito', sans-serif;
      background-color: #f4f4f4;
    }
    .header {
      text-align: center;
      padding: 20px;
      background: linear-gradient(90deg, #006D82, #008CA7);
      color: white;
      margin-bottom: 20px;
    }
    .header h1 {
      font-family: 'Barlow', sans-serif;
      font-size: 28px;
      margin-bottom: 5px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    #cart {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
    }
    #cart.visible {
      display: block;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .cart-total {
      text-align: right;
      font-weight: bold;
      margin-top: 15px;
      font-size: 18px;
    }
    #checkout-btn {
      background: green;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 5px;
      margin-top: 15px;
      cursor: pointer;
      font-weight: bold;
    }
    .filter-section {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-section select {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      flex: 1;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }
    .product-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .product-card:hover {
      transform: translateY(-3px);
    }
    .product-image-container {
      height: 180px;
      background: #f8f8f8;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 8px 8px 0 0;
      position: relative;
    }
    .product-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      padding: 5px;
      transition: transform 0.5s ease;
    }
    .product-card:hover .product-image {
      transform: scale(1.05);
    }
    .product-watermark {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 8px 5px;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
      font-family: 'Nunito', sans-serif;
      font-size: 11px;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      pointer-events: none;
      max-height: 40%;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    .product-details {
      padding: 12px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }
    .product-text {
      flex-grow: 1;
    }
    .product-name {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 40px;
    }
    .product-actions {
      margin-top: auto;
    }
    .product-price {
      color: #008ca7;
      font-weight: bold;
      font-size: 16px;
      margin: 8px 0;
    }
    .wholesale-price {
      color: #4CAF50;
      font-size: 12px;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .add-to-cart {
      background: #008ca7;
      color: white !important;
      border: none;
      padding: 8px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .add-to-cart:hover {
      background: #006d82;
    }
    .wholesale-notification {
      background: #FFF9C4;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    .modal.visible {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .modal h3 {
      margin-bottom: 15px;
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    .modal-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #add-to-cart {
      background: #008ca7;
      color: white;
    }
    #close-modal {
      background: #f44336;
      color: white;
    }
    #customer-modal .modal-content {
      max-width: 500px;
    }
    #customer-modal label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    @media (min-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (min-width: 992px) {
      .product-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>MDR STORE</h1>
    <p>Solusi Belanja Digital Cepat & Terpercaya</p>
  </div>

  <div class="container">
    <div id="cart">
      <h2>Keranjang Belanja</h2>
      <div id="cart-items"></div>
      <div class="cart-total">
        Total: Rp <span id="cart-total">0</span>
      </div>
      <button id="checkout-btn">Checkout via WhatsApp</button>
    </div>

    <div class="filter-section">
      <select id="category-filter">
        <option value="">Semua Kategori</option>
      </select>
      <select id="brand-filter">
        <option value="">Semua Brand</option>
      </select>
    </div>

    <div class="product-grid" id="product-grid"></div>
  </div>

  <div class="modal" id="qty-modal">
    <div class="modal-content">
      <h3>Masukkan Jumlah</h3>
      <input type="number" id="qty-input" min="1" value="1">
      <div id="price-info" style="margin-bottom:15px"></div>
      <div class="modal-buttons">
        <button id="add-to-cart">Tambah ke Keranjang</button>
        <button id="close-modal">Batal</button>
      </div>
    </div>
  </div>

  <div class="modal" id="customer-modal">
    <div class="modal-content">
      <h3>Data Pemesan</h3>
      <div>
        <label for="customer-name">Nama Lengkap*</label>
        <input type="text" id="customer-name" required>
      </div>
      <div>
        <label for="customer-address">Alamat Lengkap*</label>
        <textarea id="customer-address" required rows="3"></textarea>
      </div>
      <div>
        <label for="customer-phone">No. WhatsApp*</label>
        <input type="tel" id="customer-phone" required>
      </div>
      <div class="modal-buttons">
        <button id="confirm-customer">Lanjutkan Checkout</button>
        <button id="cancel-customer">Batal</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      primarySheet: {
        id: '1Qn-UWBFxghJpBfRMXvtayXBxO5I3y5rHk-we0m2J9mU',
        sheetName: 'Sheet1'
      },
      backupSources: [
        'https://backup.mdrstore.com/products.json',
        'https://api.mdrstore.com/v1/products'
      ],
      refreshInterval: 3600000, // 1 jam
      whatsappNumber: '6285134575758',
      bankAccount: {
        bankName: 'BRI',
        accountNumber: '6619-0100-0007-560',
        accountHolder: 'SUYOKO'
      }
    };

    // System Variables
    let products = [];
    let cart = [];
    let selectedProduct = null;
    let customerData = {
      name: '',
      address: '',
      phone: ''
    };

    // Wholesale Rules - HANYA untuk Voucher Internet
    const WHOLESALE_RULES = {
      "Voucher Internet": { minQty: 100, label: "Grosir (â‰¥100)" }
    };

    // Fallback Data - termasuk contoh produk Oraimo
    const fallbackProducts = [
      {
        kode: "TELK-10GB",
        brand: "Telkomsel",
        kategori: "Voucher Internet",
        produk: "Voucher Telkomsel 10GB",
        deskripsi: "ðŸŸ¡ Kuota 10GB\nðŸŸ¡ Masa berlaku 30 Hari\nðŸŸ¡ Bisa untuk semua jaringan",
        harga: 50000,
        harga_grosir: 45000,
        gambar: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Indosat_Ooredoo_Hutchison.svg/960px-Indosat_Ooredoo_Hutchison.svg.png"
      },
      {
        kode: "XL-5GB",
        brand: "XL",
        kategori: "Voucher Internet",
        produk: "Voucher XL 5GB",
        deskripsi: "ðŸŸ¡ Kuota 5GB\nðŸŸ¡ Masa berlaku 28 Hari\nðŸŸ¡ Akses 24 jam",
        harga: 30000,
        harga_grosir: 27000,
        gambar: "https://example.com/wp-content/uploads/xl-voucher.jpg"
      },
      {
        kode: "OR-CBL1M",
        brand: "Oraimo",
        kategori: "Aksesoris",
        produk: "Oraimo Cable 1m",
        deskripsi: "ðŸŸ¡ Kabel data original Oraimo\nðŸŸ¡ Panjang 1 meter\nðŸŸ¡ Fast charging",
        harga: 75000,
        harga_grosir: null,
        gambar: "https://example.com/oraimo-cable.jpg"
      },
      {
        kode: "OR-PB10K",
        brand: "Oraimo",
        kategori: "Aksesoris",
        produk: "Oraimo Powerbank 10000mAh",
        deskripsi: "ðŸŸ¡ Powerbank original Oraimo\nðŸŸ¡ Kapasitas 10000mAh\nðŸŸ¡ Fast charging",
        harga: 250000,
        harga_grosir: null,
        gambar: "https://example.com/oraimo-powerbank.jpg"
      }
    ];

    // DOM Elements
    const elements = {
      brandFilter: document.getElementById('brand-filter'),
      categoryFilter: document.getElementById('category-filter'),
      productGrid: document.getElementById('product-grid'),
      cartContainer: document.getElementById('cart'),
      cartItems: document.getElementById('cart-items'),
      cartTotal: document.getElementById('cart-total'),
      checkoutBtn: document.getElementById('checkout-btn'),
      modals: {
        qty: document.getElementById('qty-modal'),
        customer: document.getElementById('customer-modal')
      },
      inputs: {
        qty: document.getElementById('qty-input'),
        customerName: document.getElementById('customer-name'),
        customerAddress: document.getElementById('customer-address'),
        customerPhone: document.getElementById('customer-phone')
      },
      buttons: {
        addToCart: document.getElementById('add-to-cart'),
        closeModal: document.getElementById('close-modal'),
        confirmCustomer: document.getElementById('confirm-customer'),
        cancelCustomer: document.getElementById('cancel-customer')
      }
    };

    // Utility Functions
    const utils = {
      getWholesaleRule: (kategori) => WHOLESALE_RULES[kategori] || null,
      
      getTotalQtyByCategory: (cart, category) => {
        return cart.reduce((total, item) => item.kategori === category ? total + item.qty : total, 0);
      },
      
      formatProductName: (name) => {
        if (name.includes("Oraimo")) {
          return name.replace(/\s+/g, ' ').trim();
        }
        return name
          .replace(/(Baseus|Telkomsel)\s+/gi, '')
          .replace(/Model\s+\w+-\w+/i, '')
          .replace(/\s+/g, ' ')
          .trim();
      },
      
      getShortDescription: (desc) => {
        const points = desc.split('\n')
                          .filter(line => line.trim().startsWith('ðŸŸ¡'))
                          .slice(0, 2)
                          .map(line => line.replace('ðŸŸ¡', 'â€¢').trim());
        return points.length > 0 ? points.join(' | ') : "Produk berkualitas MDR STORE";
      },
      
      formatDescription: (desc) => desc.replace(/(ðŸŸ¡)/g, '\n$1').trim(),
      
      getImageUrl: (url) => url || 'https://via.placeholder.com/150?text=No+Image',
      
      formatCurrency: (amount) => new Intl.NumberFormat('id-ID').format(amount),
      
      validatePhone: (phone) => {
        const phoneRegex = /^[0-9]{10,15}$/;
        return phoneRegex.test(phone.replace(/\D/g, ''));
      },
      
      formatOrderItem: (item, index) => {
        return `${index + 1}. ${utils.formatProductName(item.produk)} (${item.kode || '-'})\n` +
               `   â€¢ Jumlah: ${item.qty} pcs\n` +
               `   â€¢ Harga: Rp ${utils.formatCurrency(item.harga)}${item.isWholesale ? ' (Grosir)' : ''}\n` +
               `   â€¢ Subtotal: Rp ${utils.formatCurrency(item.qty * item.harga)}\n\n`;
      }
    };

    // Data Loading Functions
    const dataService = {
      fetchPrimaryData: async () => {
        try {
          const url = `https://opensheet.elk.sh/${CONFIG.primarySheet.id}/${CONFIG.primarySheet.sheetName}`;
          const response = await fetch(url);
          
          if (!response.ok) throw new Error('Failed to fetch primary data');
          return await response.json();
        } catch (error) {
          console.error('Primary data error:', error);
          return null;
        }
      },
      
      fetchBackupData: async () => {
        for (const url of CONFIG.backupSources) {
          try {
            const response = await fetch(url);
            if (response.ok) return await response.json();
          } catch (e) {
            console.warn(`Backup failed (${url}):`, e);
          }
        }
        return null;
      },
      
      processRawData: (rawData) => {
        return rawData.map(item => ({
          kode: item['Kode Produk'] || item.kode || '',
          brand: item.Brand || item.brand || '',
          kategori: item['Nama Kategori'] || item.kategori || '',
          produk: item['Nama Produk'] || item.produk || '',
          deskripsi: item.Deskripsi || item.deskripsi || '-',
          harga: parseInt(item.Harga?.replace(/\D/g, '') || item.harga || 0),
          harga_grosir: item.kategori === "Voucher Internet" ? 
                       parseInt(item['Harga Grosir']?.replace(/\D/g, '') || item.harga_grosir || null) : 
                       null,
          gambar: item['Gambar URL'] || item.gambar || ''
        }));
      },
      
      loadProducts: async () => {
        let rawData = await dataService.fetchPrimaryData();
        
        if (!rawData) {
          console.warn('Using backup data');
          rawData = await dataService.fetchBackupData() || fallbackProducts;
        }
        
        products = dataService.processRawData(rawData);
        ui.updateFilters();
        ui.renderProducts();
        
        setTimeout(dataService.loadProducts, CONFIG.refreshInterval);
      }
    };

    // UI Functions
    const ui = {
      updateFilters: () => {
        elements.categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
        [...new Set(products.map(p => p.kategori))].forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          elements.categoryFilter.appendChild(option);
        });
        
        ui.updateBrandFilter();
      },
      
      updateBrandFilter: () => {
        elements.brandFilter.innerHTML = '<option value="">Semua Brand</option>';
        const selectedCategory = elements.categoryFilter.value;
        let filteredProducts = selectedCategory 
          ? products.filter(p => p.kategori === selectedCategory)
          : products;
          
        [...new Set(filteredProducts.map(p => p.brand))].forEach(brand => {
          const option = document.createElement('option');
          option.value = brand;
          option.textContent = brand;
          elements.brandFilter.appendChild(option);
        });
      },
      
      renderProducts: () => {
        elements.productGrid.innerHTML = '';
        const selectedCategory = elements.categoryFilter.value;
        const selectedBrand = elements.brandFilter.value;
        
        let filteredProducts = products;
        if (selectedCategory) filteredProducts = filteredProducts.filter(p => p.kategori === selectedCategory);
        if (selectedBrand) filteredProducts = filteredProducts.filter(p => p.brand === selectedBrand);
        
        filteredProducts.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          const productName = utils.formatProductName(product.produk);
          const isVoucherInternet = product.kategori === "Voucher Internet";
          const hasWholesale = isVoucherInternet && product.harga_grosir !== null;
          const rule = utils.getWholesaleRule(product.kategori);
          
          card.innerHTML = `
            <div class="product-image-container">
              <img src="${utils.getImageUrl(product.gambar)}" alt="${productName}" class="product-image" loading="lazy">
              <div class="product-watermark">${product.kode ? product.kode + ' | ' : ''}MDR STORE</div>
            </div>
            <div class="product-details">
              <div class="product-text">
                <div class="product-name">${productName}</div>
              </div>
              <div class="product-actions">
                <div class="product-price">Rp ${utils.formatCurrency(product.harga)}</div>
                ${hasWholesale ? `
                  <div class="wholesale-price">${rule.label}: Rp ${utils.formatCurrency(product.harga_grosir)}</div>
                ` : ''}
                <button class="add-to-cart">+ Keranjang</button>
              </div>
            </div>
          `;
          
          card.querySelector('.add-to-cart').addEventListener('click', (e) => {
            e.stopPropagation();
            selectedProduct = product;
            ui.showModal();
          });
          
          card.addEventListener('click', () => {
            ui.showProductDetail(product);
          });
          
          elements.productGrid.appendChild(card);
        });
      },
      
      showProductDetail: (product) => {
        const productName = utils.formatProductName(product.produk);
        const productDesc = utils.formatDescription(product.deskripsi);
        const isVoucherInternet = product.kategori === "Voucher Internet";
        const hasWholesale = isVoucherInternet && product.harga_grosir !== null;
        const rule = utils.getWholesaleRule(product.kategori);
        
        const detailModal = `
          <div class="modal visible" id="detail-modal">
            <div class="modal-content" style="max-width:500px">
              <h3>${productName}</h3>
              <p><small>Kode: ${product.kode || '-'}</small></p>
              <img src="${utils.getImageUrl(product.gambar)}" alt="${productName}" style="width:100%;max-height:200px;object-fit:contain;margin:10px 0">
              <p><strong>Brand:</strong> ${product.brand}</p>
              <p><strong>Kategori:</strong> ${product.kategori}</p>
              <p><strong>Harga:</strong> Rp ${utils.formatCurrency(product.harga)}</p>
              ${hasWholesale ? `
                <p><strong>${rule.label}:</strong> Rp ${utils.formatCurrency(product.harga_grosir)}</p>
              ` : ''}
              <p><strong>Deskripsi:</strong></p>
              <p style="white-space: pre-line">${productDesc}</p>
              <div class="modal-buttons">
                <button id="add-from-detail" style="background:#008ca7;color:white">Tambah ke Keranjang</button>
                <button id="close-detail" style="background:#f44336;color:white">Tutup</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailModal);
        
        document.getElementById('close-detail').addEventListener('click', () => {
          document.getElementById('detail-modal').remove();
        });
        
        document.getElementById('add-from-detail').addEventListener('click', () => {
          selectedProduct = product;
          document.getElementById('detail-modal').remove();
          ui.showModal();
        });
      },
      
      showModal: () => {
        elements.inputs.qty.value = 1;
        elements.modals.qty.classList.add('visible');
        ui.updatePriceInfo();
        elements.inputs.qty.addEventListener('input', ui.updatePriceInfo);
      },
      
      updatePriceInfo: () => {
        const qty = parseInt(elements.inputs.qty.value) || 1;
        let price = selectedProduct.harga;
        let isWholesale = false;
        
        if (selectedProduct.kategori === "Voucher Internet" && selectedProduct.harga_grosir !== null) {
          const rule = utils.getWholesaleRule(selectedProduct.kategori);
          const totalQtyInCart = utils.getTotalQtyByCategory(cart, selectedProduct.kategori);
          const totalQty = totalQtyInCart + qty;
          
          if (totalQty >= rule.minQty) {
            price = selectedProduct.harga_grosir;
            isWholesale = true;
          }
        }
        
        const total = price * qty;
        elements.priceInfo.innerHTML = `
          <div><strong>Harga Satuan:</strong> Rp ${utils.formatCurrency(price)} ${isWholesale ? '(Grosir)' : ''}</div>
          <div><strong>Total:</strong> Rp ${utils.formatCurrency(total)}</div>
          ${selectedProduct.kategori === "Voucher Internet" && selectedProduct.harga_grosir !== null ? `
            <div style="margin-top:5px;font-size:12px;color:#666">
              ${!isWholesale ? `Total ${utils.getTotalQtyByCategory(cart, selectedProduct.kategori)} pcs di keranjang. Beli ${100 - utils.getTotalQtyByCategory(cart, selectedProduct.kategori)} pcs lagi untuk dapat harga grosir!` : ''}
            </div>
          ` : ''}
        `;
      },
      
      hideModal: () => {
        elements.modals.qty.classList.remove('visible');
        elements.inputs.qty.removeEventListener('input', ui.updatePriceInfo);
      },
      
      updateCart: () => {
        elements.cartItems.innerHTML = '';
        
        if (cart.length === 0) {
          elements.cartContainer.classList.remove('visible');
          return;
        }
        
        const categoriesInCart = [...new Set(cart.map(item => item.kategori))];
        categoriesInCart.forEach(category => {
          if (category === "Voucher Internet") {
            const rule = utils.getWholesaleRule(category);
            const totalQty = utils.getTotalQtyByCategory(cart, category);
            const shouldApplyWholesale = totalQty >= rule.minQty;
            
            cart.forEach(item => {
              if (item.kategori === category && item.harga_grosir !== null) {
                item.harga = shouldApplyWholesale ? item.harga_grosir : item.harga;
                item.isWholesale = shouldApplyWholesale;
              }
            });
          }
        });
        
        elements.cartContainer.classList.add('visible');
        let total = 0;
        
        cart.forEach((item, index) => {
          const subtotal = item.harga * item.qty;
          total += subtotal;
          
          const cartItem = document.createElement('div');
          cartItem.className = 'cart-item';
          cartItem.innerHTML = `
            <div>
              <div>${utils.formatProductName(item.produk)} (${item.kode || '-'})</div>
              <div>${item.qty} x Rp ${utils.formatCurrency(item.harga)}</div>
              ${item.isWholesale ? `<div style="color:#4CAF50;font-size:12px">(Harga Grosir)</div>` : ''}
            </div>
            <div>
              <button onclick="app.removeFromCart(${index})">Hapus</button>
            </div>
          `;
          elements.cartItems.appendChild(cartItem);
        });
        
        categoriesInCart.forEach(category => {
          if (category === "Voucher Internet") {
            const rule = utils.getWholesaleRule(category);
            const totalQty = utils.getTotalQtyByCategory(cart, category);
            const remaining = rule.minQty - totalQty;
            
            if (remaining > 0 && cart.some(item => item.kategori === category && item.harga_grosir)) {
              elements.cartItems.innerHTML += `
                <div class="wholesale-notification">
                  Beli ${remaining} pcs lagi dalam kategori ${category} untuk dapat harga grosir!
                </div>
              `;
            }
          }
        });
        
        elements.cartTotal.textContent = utils.formatCurrency(total);
      },
      
      checkout: () => {
        if (cart.length === 0) {
          alert('Keranjang belanja kosong!');
          return;
        }
        ui.showCustomerModal();
      },
      
      showCustomerModal: () => {
        elements.inputs.customerName.value = localStorage.getItem('customerName') || '';
        elements.inputs.customerAddress.value = localStorage.getItem('customerAddress') || '';
        elements.inputs.customerPhone.value = localStorage.getItem('customerPhone') || '';
        elements.modals.customer.classList.add('visible');
      },
      
      generateOrderMessage: () => {
        let message = `*FORMAT PEMESANAN - MDR STORE*\n`;
        message += `==============================\n\n`;
        message += `*DATA PELANGGAN*\n`;
        message += `Nama: ${customerData.name}\n`;
        message += `Alamat: ${customerData.address}\n`;
        message += `WhatsApp: ${customerData.phone}\n\n`;
        message += `*DETAIL PESANAN*\n`;
        
        const categories = [...new Set(cart.map(item => item.kategori))];
        let totalPayment = 0;
        
        categories.forEach(category => {
          const categoryItems = cart.filter(item => item.kategori === category);
          const rule = utils.getWholesaleRule(category);
          const totalQty = utils.getTotalQtyByCategory(cart, category);
          
          message += `*${category.toUpperCase()}* (Total: ${totalQty} pcs${category === "Voucher Internet" && totalQty >= rule?.minQty ? ' - HARGA GROSIR' : ''})\n`;
          
          categoryItems.forEach((item, index) => {
            message += utils.formatOrderItem(item, index);
            totalPayment += item.harga * item.qty;
          });
        });

        message += `*TOTAL PEMBAYARAN: Rp ${utils.formatCurrency(totalPayment)}*\n\n`;
        message += `*INSTRUKSI PEMBAYARAN*\n`;
        message += `1. Transfer ke rekening berikut:\n`;
        message += `   Bank: ${CONFIG.bankAccount.bankName}\n`;
        message += `   No. Rek: ${CONFIG.bankAccount.accountNumber}\n`;
        message += `   A/N: ${CONFIG.bankAccount.accountHolder}\n\n`;
        message += `2. Konfirmasi pembayaran dengan mengirim bukti transfer\n\n`;
        message += `_Pesanan akan diproses dalam 1x24 jam setelah pembayaran diverifikasi_\n\n`;
        message += `*Terima kasih telah berbelanja di MDR STORE*`;

        return message;
      }
    };

    // Core Application
    const app = {
      addToCart: () => {
        const qty = parseInt(elements.inputs.qty.value);
        if (qty > 0 && selectedProduct) {
          let price = selectedProduct.harga;
          let isWholesale = false;
          
          if (selectedProduct.kategori === "Voucher Internet" && selectedProduct.harga_grosir !== null) {
            const rule = utils.getWholesaleRule(selectedProduct.kategori);
            const totalQtyInCategory = utils.getTotalQtyByCategory(cart, selectedProduct.kategori) + qty;
            isWholesale = totalQtyInCategory >= rule.minQty;
            
            if (isWholesale) {
              price = selectedProduct.harga_grosir;
            }
          }
          
          const existingItemIndex = cart.findIndex(item => 
            item.produk === selectedProduct.produk && 
            item.harga === price
          );
          
          if (existingItemIndex >= 0) {
            cart[existingItemIndex].qty += qty;
          } else {
            cart.push({
              ...selectedProduct,
              harga: price,
              qty: qty,
              isWholesale: isWholesale
            });
          }
          
          ui.updateCart();
          ui.hideModal();
        }
      },
      
      removeFromCart: (index) => {
        cart.splice(index, 1);
        ui.updateCart();
      },
      
      processCheckout: () => {
        const name = elements.inputs.customerName.value.trim();
        const address = elements.inputs.customerAddress.value.trim();
        const phone = elements.inputs.customerPhone.value.trim();
        
        if (!name || !address || !phone) {
          alert('Harap lengkapi semua data pemesan!');
          return;
        }
        
        if (!utils.validatePhone(phone)) {
          alert('Nomor WhatsApp tidak valid! Harap masukkan 10-15 digit nomor.');
          return;
        }
        
        localStorage.setItem('customerName', name);
        localStorage.setItem('customerAddress', address);
        localStorage.setItem('customerPhone', phone);
        
        customerData = { name, address, phone };
        
        const message = ui.generateOrderMessage();
        const whatsappUrl = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
        
        cart = [];
        ui.updateCart();
        elements.modals.customer.classList.remove('visible');
        
        alert('Pesanan berhasil dibuat! Silahkan lanjutkan pembayaran via WhatsApp.');
      },
      
      init: () => {
        elements.categoryFilter.addEventListener('change', () => {
          ui.updateBrandFilter();
          ui.renderProducts();
        });
        
        elements.brandFilter.addEventListener('change', ui.renderProducts);
        
        elements.buttons.addToCart.addEventListener('click', app.addToCart);
        elements.buttons.closeModal.addEventListener('click', ui.hideModal);
        elements.checkoutBtn.addEventListener('click', ui.checkout);
        elements.buttons.confirmCustomer.addEventListener('click', app.processCheckout);
        elements.buttons.cancelCustomer.addEventListener('click', () => {
          elements.modals.customer.classList.remove('visible');
        });
        
        window.removeFromCart = app.removeFromCart;
        dataService.loadProducts();
        
        const savedName = localStorage.getItem('customerName');
        if (savedName) {
          customerData.name = savedName;
          elements.inputs.customerName.value = savedName;
        }
      }
    };

    document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>
</html>