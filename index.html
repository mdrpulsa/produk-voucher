<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Produk - MDR STORE</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@600&family=Nunito:wght@400;700&display=swap');

    /* Reset dan dasar */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Nunito', sans-serif;
      background-color: #f4f4f4;
    }
    /* Header */
    .header {
      text-align: center;
      padding: 20px;
      background: linear-gradient(90deg, #006D82, #008CA7);
      color: white;
      margin-bottom: 20px;
    }
    .header h1 {
      font-family: 'Barlow', sans-serif;
      font-size: 28px;
      margin-bottom: 5px;
    }
    /* Container utama */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    /* Keranjang */
    #cart {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
    }
    #cart.visible {
      display: block;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .cart-total {
      text-align: right;
      font-weight: bold;
      margin-top: 15px;
      font-size: 18px;
    }
    #checkout-btn {
      background: green;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 5px;
      margin-top: 15px;
      cursor: pointer;
      font-weight: bold;
    }
    /* Filter */
    .filter-section {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-section select {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      flex: 1;
    }
    /* Grid Produk */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }
    .product-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .product-card:hover {
      transform: translateY(-3px);
    }
    .product-image-container {
      height: 120px;
      background: #f8f8f8;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .product-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      padding: 10px;
    }
    .product-details {
      padding: 12px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }
    .product-text {
      flex-grow: 1;
    }
    .product-name {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 40px;
    }
    .product-desc {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      white-space: pre-line;
      line-height: 1.5;
    }
    .product-actions {
      margin-top: auto;
    }
    .product-price {
      color: #008ca7;
      font-weight: bold;
      font-size: 16px;
      margin: 8px 0;
    }
    .wholesale-price {
      color: #4CAF50;
      font-size: 14px;
      margin-bottom: 3px;
    }
    .wholesale-info {
      font-size: 12px;
      color: #4CAF50;
      margin-bottom: 5px;
    }
    .add-to-cart {
      background: #008ca7;
      color: white !important;
      border: none;
      padding: 8px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .add-to-cart:hover {
      background: #006d82;
    }
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    .modal.visible {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .modal h3 {
      margin-bottom: 15px;
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    .modal-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #add-to-cart {
      background: #008ca7;
      color: white;
    }
    #close-modal {
      background: #f44336;
      color: white;
    }
    /* Customer Modal */
    #customer-modal .modal-content {
      max-width: 500px;
    }
    #customer-modal label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    /* Responsif - Tablet dan Desktop */
    @media (min-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (min-width: 992px) {
      .product-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>MDR STORE</h1>
    <p>Solusi Belanja Digital Cepat & Terpercaya</p>
  </div>

  <div class="container">
    <!-- Keranjang -->
    <div id="cart">
      <h2>Keranjang Belanja</h2>
      <div id="cart-items"></div>
      <div class="cart-total">
        Total: Rp <span id="cart-total">0</span>
      </div>
      <button id="checkout-btn">Checkout via WhatsApp</button>
    </div>

    <!-- Filter -->
    <div class="filter-section">
      <select id="brand-filter">
        <option value="">Semua Brand</option>
      </select>
      <select id="category-filter">
        <option value="">Semua Kategori</option>
      </select>
    </div>

    <!-- Grid Produk -->
    <div class="product-grid" id="product-grid"></div>
  </div>

  <!-- Modal Qty -->
  <div class="modal" id="qty-modal">
    <div class="modal-content">
      <h3>Masukkan Jumlah</h3>
      <input type="number" id="qty-input" min="1" value="1">
      <div id="price-info" style="margin-bottom:15px"></div>
      <div class="modal-buttons">
        <button id="add-to-cart">Tambah ke Keranjang</button>
        <button id="close-modal">Batal</button>
      </div>
    </div>
  </div>

  <!-- Modal Customer Data -->
  <div class="modal" id="customer-modal">
    <div class="modal-content">
      <h3>Data Pemesan</h3>
      <div>
        <label for="customer-name">Nama Lengkap*</label>
        <input type="text" id="customer-name" required>
      </div>
      <div>
        <label for="customer-address">Alamat Lengkap*</label>
        <textarea id="customer-address" required rows="3"></textarea>
      </div>
      <div>
        <label for="customer-phone">No. WhatsApp*</label>
        <input type="tel" id="customer-phone" required>
      </div>
      <div class="modal-buttons">
        <button id="confirm-customer">Lanjutkan Checkout</button>
        <button id="cancel-customer">Batal</button>
      </div>
    </div>
  </div>

  <script>
    // Data produk
    let products = [];
    let cart = [];
    let selectedProduct = null;
    let customerData = {
      name: '',
      address: '',
      phone: ''
    };

    // ========== KONFIGURASI GROSIR PER KATEGORI ==========
    const WHOLESALE_RULES = {
      "Voucher": {
        minQty: 150,
        label: "Grosir (â‰¥150 pcs)"
      },
      "Kabel Data": {
        minQty: 50,
        label: "Grosir (â‰¥50 pcs)"
      },
      "Charger": {
        minQty: 30,
        label: "Grosir (â‰¥30 pcs)"
      },
      "Case HP": {
        minQty: 20,
        label: "Grosir (â‰¥20 pcs)"
      },
      "Powerbank": {
        minQty: 10,
        label: "Grosir (â‰¥10 pcs)"
      },
      "Default": {
        minQty: 100,
        label: "Grosir (â‰¥100 pcs)"
      }
    };

    // Fungsi helper untuk mendapatkan aturan grosir
    function getWholesaleRule(kategori) {
      return WHOLESALE_RULES[kategori] || WHOLESALE_RULES["Default"];
    }

    // Fungsi untuk memformat nama produk
    function formatProductName(name) {
      return name
        .replace(/(Oraimo|Baseus|Telkomsel)\s+/gi, '')
        .replace(/Model\s+\w+-\w+/i, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Fungsi untuk memformat deskripsi (pertahankan format asli dengan emoji)
    function formatDescription(desc) {
      // Jika sudah ada line breaks, pertahankan
      if (desc.includes('\n')) {
        return desc.trim();
      }
      // Jika emoji berurutan dalam satu baris, pisahkan ke baris baru
      return desc
        .replace(/(ðŸŸ¡)/g, '\n$1')
        .trim();
    }

    // DOM Elements
    const brandFilter = document.getElementById('brand-filter');
    const categoryFilter = document.getElementById('category-filter');
    const productGrid = document.getElementById('product-grid');
    const cartContainer = document.getElementById('cart');
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const checkoutBtn = document.getElementById('checkout-btn');
    const modal = document.getElementById('qty-modal');
    const qtyInput = document.getElementById('qty-input');
    const priceInfo = document.getElementById('price-info');
    const addToCartBtn = document.getElementById('add-to-cart');
    const closeModalBtn = document.getElementById('close-modal');
    const customerModal = document.getElementById('customer-modal');
    const customerName = document.getElementById('customer-name');
    const customerAddress = document.getElementById('customer-address');
    const customerPhone = document.getElementById('customer-phone');
    const confirmCustomerBtn = document.getElementById('confirm-customer');
    const cancelCustomerBtn = document.getElementById('cancel-customer');

    // Fetch data dari Google Sheet
    function loadProducts() {
      fetch('https://opensheet.elk.sh/1Qn-UWBFxghJpBfRMXvtayXBxO5I3y5rHk-we0m2J9mU/Sheet1')
        .then(res => res.json())
        .then(data => {
          products = data.map(item => ({
            brand: item.Brand,
            kategori: item['Nama Kategori'],
            produk: item['Nama Produk'],
            deskripsi: item.Deskripsi || '-',
            harga: parseInt(item.Harga.replace(/\D/g, '')) || 0,
            harga_grosir: parseInt(item['Harga Grosir']?.replace(/\D/g, '')) || null,
            gambar: item['Gambar URL'] || 'https://via.placeholder.com/150?text=No+Image'
          }));
          renderBrands();
          renderProducts();
        })
        .catch(error => {
          console.error('Error loading products:', error);
          // Fallback data jika fetch gagal
          products = [
            {
              brand: "Telkomsel",
              kategori: "Voucher",
              produk: "Voucher Telkomsel 100rb",
              deskripsi: "ðŸŸ¡ Kuota 3GB\nðŸŸ¡ Masa berlaku 28 Hari",
              harga: 95000,
              harga_grosir: 85000,
              gambar: "https://via.placeholder.com/150"
            },
            {
              brand: "Oraimo",
              kategori: "Kabel Data",
              produk: "Oraimo Kabel Data Micro USB - Model OCD-113M (1M)",
              deskripsi: "ðŸŸ¡ Fast Charging 2.4A\nðŸŸ¡ Panjang 1 Meter\nðŸŸ¡ Tahan lama",
              harga: 50000,
              harga_grosir: 45000,
              gambar: "https://via.placeholder.com/150"
            }
          ];
          renderBrands();
          renderProducts();
        });
    }

    // Render brand filter
    function renderBrands() {
      const brands = [...new Set(products.map(p => p.brand))];
      brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandFilter.appendChild(option);
      });
    }

    // Render kategori filter berdasarkan brand yang dipilih
    function renderCategories() {
      categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
      
      const selectedBrand = brandFilter.value;
      let filteredProducts = products;
      
      if (selectedBrand) {
        filteredProducts = products.filter(p => p.brand === selectedBrand);
      }
      
      const categories = [...new Set(filteredProducts.map(p => p.kategori))];
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });
    }

    // Render produk ke grid
    function renderProducts() {
      productGrid.innerHTML = '';
      
      const selectedBrand = brandFilter.value;
      const selectedCategory = categoryFilter.value;
      
      let filteredProducts = products;
      
      if (selectedBrand) {
        filteredProducts = filteredProducts.filter(p => p.brand === selectedBrand);
      }
      
      if (selectedCategory) {
        filteredProducts = filteredProducts.filter(p => p.kategori === selectedCategory);
      }
      
      filteredProducts.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        // Format nama dan deskripsi
        const productName = formatProductName(product.produk);
        const productDesc = formatDescription(product.deskripsi);
        const hasWholesale = product.harga_grosir !== null;
        const rule = getWholesaleRule(product.kategori);
        
        card.innerHTML = `
          <div class="product-image-container">
            <img src="${product.gambar}" alt="${productName}" class="product-image">
          </div>
          <div class="product-details">
            <div class="product-text">
              <div class="product-name">${productName}</div>
              <div class="product-desc">${productDesc}</div>
            </div>
            <div class="product-actions">
              <div class="product-price">Rp ${product.harga.toLocaleString('id-ID')}</div>
              ${hasWholesale ? `
                <div class="wholesale-price">${rule.label}: Rp ${product.harga_grosir.toLocaleString('id-ID')}</div>
                <div class="wholesale-info">Min. pembelian ${rule.minQty} pcs</div>
              ` : ''}
              <button class="add-to-cart">+ Keranjang</button>
            </div>
          </div>
        `;
        
        card.querySelector('.add-to-cart').addEventListener('click', (e) => {
          e.stopPropagation();
          selectedProduct = product;
          showModal();
        });

        card.addEventListener('click', () => {
          showProductDetail(product);
        });
        
        productGrid.appendChild(card);
      });
    }

    // Fungsi untuk menampilkan detail produk
    function showProductDetail(product) {
      const productName = formatProductName(product.produk);
      const productDesc = formatDescription(product.deskripsi);
      const hasWholesale = product.harga_grosir !== null;
      const rule = getWholesaleRule(product.kategori);
      
      const detailModal = `
        <div class="modal visible" id="detail-modal">
          <div class="modal-content" style="max-width:500px">
            <h3>${productName}</h3>
            <img src="${product.gambar}" alt="${productName}" 
                 style="width:100%;max-height:200px;object-fit:contain;margin:10px 0">
            <p><strong>Brand:</strong> ${product.brand}</p>
            <p><strong>Kategori:</strong> ${product.kategori}</p>
            <p><strong>Harga:</strong> Rp ${product.harga.toLocaleString('id-ID')}</p>
            ${hasWholesale ? `
              <p><strong>${rule.label}:</strong> Rp ${product.harga_grosir.toLocaleString('id-ID')}</p>
              <p><strong>Minimal Grosir:</strong> ${rule.minQty} pcs</p>
            ` : ''}
            <p><strong>Deskripsi:</strong></p>
            <p class="product-desc">${productDesc}</p>
            <div class="modal-buttons">
              <button id="add-from-detail" style="background:#008ca7;color:white">Tambah ke Keranjang</button>
              <button id="close-detail" style="background:#f44336;color:white">Tutup</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', detailModal);
      
      document.getElementById('close-detail').addEventListener('click', () => {
        document.getElementById('detail-modal').remove();
      });

      document.getElementById('add-from-detail').addEventListener('click', () => {
        selectedProduct = product;
        document.getElementById('detail-modal').remove();
        showModal();
      });
    }

    // Tampilkan modal
    function showModal() {
      qtyInput.value = 1;
      modal.classList.add('visible');
      updatePriceInfo();
      
      // Update info harga saat jumlah berubah
      qtyInput.addEventListener('input', updatePriceInfo);
    }

    // Update info harga berdasarkan kuantitas
    function updatePriceInfo() {
      const qty = parseInt(qtyInput.value) || 1;
      let price = selectedProduct.harga;
      let isWholesale = false;
      let rule = getWholesaleRule(selectedProduct.kategori);
      
      // Cek apakah produk punya harga grosir dan memenuhi syarat
      if (selectedProduct.harga_grosir !== null && qty >= rule.minQty) {
        price = selectedProduct.harga_grosir;
        isWholesale = true;
      }
      
      const total = price * qty;
      
      priceInfo.innerHTML = `
        <div><strong>Harga Satuan:</strong> Rp ${price.toLocaleString('id-ID')} ${isWholesale ? '(Grosir)' : ''}</div>
        <div><strong>Total:</strong> Rp ${total.toLocaleString('id-ID')}</div>
        ${selectedProduct.harga_grosir !== null ? `
          <div style="margin-top:5px;font-size:12px;color:#666">
            ${!isWholesale ? `Beli ${rule.minQty - qty} lagi untuk dapat harga grosir Rp ${selectedProduct.harga_grosir.toLocaleString('id-ID')}` : ''}
          </div>
        ` : ''}
      `;
    }

    // Sembunyikan modal
    function hideModal() {
      modal.classList.remove('visible');
      qtyInput.removeEventListener('input', updatePriceInfo);
    }

    // Tambah ke keranjang
    function addToCart() {
      const qty = parseInt(qtyInput.value);
      
      if (qty > 0 && selectedProduct) {
        let price = selectedProduct.harga;
        let isWholesale = false;
        let rule = getWholesaleRule(selectedProduct.kategori);
        
        // Gunakan harga grosir jika memenuhi syarat
        if (selectedProduct.harga_grosir !== null && qty >= rule.minQty) {
          price = selectedProduct.harga_grosir;
          isWholesale = true;
        }
        
        const existingItemIndex = cart.findIndex(item => 
          item.produk === selectedProduct.produk && 
          item.harga === price
        );
        
        if (existingItemIndex >= 0) {
          cart[existingItemIndex].qty += qty;
        } else {
          cart.push({
            ...selectedProduct,
            harga: price,
            qty: qty,
            isWholesale: isWholesale
          });
        }
        
        updateCart();
        hideModal();
      }
    }

    // Update tampilan keranjang
    function updateCart() {
      cartItems.innerHTML = '';
      
      if (cart.length === 0) {
        cartContainer.classList.remove('visible');
        return;
      }
      
      cartContainer.classList.add('visible');
      
      let total = 0;
      
      cart.forEach((item, index) => {
        const subtotal = item.harga * item.qty;
        total += subtotal;
        
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
          <div>
            <div>${formatProductName(item.produk)}</div>
            <div>${item.qty} x Rp ${item.harga.toLocaleString('id-ID')}</div>
            ${item.isWholesale ? `<div style="color:#4CAF50;font-size:12px">(Harga Grosir)</div>` : ''}
          </div>
          <div>
            <button onclick="removeFromCart(${index})">Hapus</button>
          </div>
        `;
        
        cartItems.appendChild(cartItem);
      });
      
      cartTotal.textContent = total.toLocaleString('id-ID');
    }

    // Hapus item dari keranjang
    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCart();
    }

    // Proses checkout awal (tampilkan modal data pelanggan)
    function checkout() {
      if (cart.length === 0) {
        alert('Keranjang belanja kosong!');
        return;
      }
      
      // Reset form
      customerName.value = '';
      customerAddress.value = '';
      customerPhone.value = '';
      
      // Tampilkan modal data pelanggan
      customerModal.classList.add('visible');
    }

    // Proses checkout akhir (setelah data pelanggan diisi)
    function processCheckout() {
      if (!customerName.value || !customerAddress.value || !customerPhone.value) {
        alert('Harap lengkapi semua data pemesan!');
        return;
      }
      
      // Simpan data pelanggan
      customerData = {
        name: customerName.value,
        address: customerAddress.value,
        phone: customerPhone.value
      };
      
      // Generate pesan WhatsApp
      const message = generateOrderMessage();
      const whatsappUrl = `https://wa.me/6285134575758?text=${encodeURIComponent(message)}`;
      
      // Buka WhatsApp
      window.open(whatsappUrl, '_blank');
      
      // Tutup modal
      customerModal.classList.remove('visible');
    }

    // Generate pesan pemesanan
    function generateOrderMessage() {
      // Header
      let message = `*FORMAT PEMESANAN - MDR STORE*\n`;
      message += `==============================\n\n`;
      
      // Data pelanggan
      message += `*DATA PELANGGAN*\n`;
      message += `Nama: ${customerData.name}\n`;
      message += `Alamat: ${customerData.address}\n`;
      message += `WhatsApp: ${customerData.phone}\n\n`;
      
      // Detail pesanan
      message += `*DETAIL PESANAN*\n`;
      cart.forEach((item, index) => {
        const rule = getWholesaleRule(item.kategori);
        
        message += `${index + 1}. ${formatProductName(item.produk)} (${item.brand || '-'})\n`;
        message += `   â–ª Jumlah: ${item.qty} pcs\n`;
        message += `   â–ª Harga: Rp ${item.harga.toLocaleString('id-ID')} ${item.isWholesale ? `(Grosir â‰¥${rule.minQty} pcs)` : ''}\n`;
        message += `   â–ª Subtotal: Rp ${(item.qty * item.harga).toLocaleString('id-ID')}\n\n`;
      });

      // Total pembayaran
      const total = cart.reduce((sum, item) => sum + (item.harga * item.qty), 0);
      message += `*TOTAL PEMBAYARAN: Rp ${total.toLocaleString('id-ID')}*\n\n`;
      
      // Instruksi pembayaran
      message += `*INSTRUKSI PEMBAYARAN*\n`;
      message += `1. Transfer ke rekening berikut:\n`;
      message += `   Bank: BRI\n`;
      message += `   No. Rek: 6619-0100-0007-560\n`;
      message += `   A/N: SUYOKO\n\n`;
      message += `2. Konfirmasi pembayaran dengan mengirim bukti transfer\n\n`;
      message += `_Pesanan akan diproses dalam 1x24 jam setelah pembayaran diverifikasi_`;

      return message;
    }

    // Event listeners
    brandFilter.addEventListener('change', () => {
      renderCategories();
      renderProducts();
    });
    
    categoryFilter.addEventListener('change', renderProducts);
    
    addToCartBtn.addEventListener('click', addToCart);
    
    closeModalBtn.addEventListener('click', hideModal);
    
    checkoutBtn.addEventListener('click', checkout);
    
    confirmCustomerBtn.addEventListener('click', processCheckout);
    
    cancelCustomerBtn.addEventListener('click', () => {
      customerModal.classList.remove('visible');
    });

    // Inisialisasi
    window.removeFromCart = removeFromCart;
    loadProducts();
  </script>
</body>
</html>
