<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog Produk - MDR STORE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css">
  <link rel="icon" type="image/png" href="https://mdrpulsadata.wordpress.com/wp-content/uploads/2025/05/logo-favicon-48-x-44-px.png">
  <style>
    /* Base Styles */
    @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@600&family=Nunito:wght@400;500;700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Nunito', sans-serif;
      background-color: #F6F6F6;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      padding-top: 130px;
      color: #393232;
    }

    /* Header Styles */
    .header {
      text-align: center;
      padding: 20px;
      background: linear-gradient(90deg, #005f73, #008ca7);
      color: white;
      margin-bottom: 20px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-family: 'Barlow', sans-serif;
      font-size: 28px;
      margin-bottom: 5px;
      letter-spacing: 0.5px;
    }

    /* Category Tabs Styles */
    .category-tabs {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 15px;
      background: white;
      margin-bottom: 20px;
      scrollbar-width: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .category-tabs::-webkit-scrollbar {
      display: none;
    }

    .tab-btn {
      flex: 0 0 auto;
      padding: 10px 20px;
      border: none;
      background: #F2F2F2;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      color: #393232;
    }

    .tab-btn.active {
      background: #008ca7;
      color: white;
      box-shadow: 0 2px 5px rgba(58, 99, 81, 0.3);
    }

    /* Cart Icon Styles */
    .cart-icon-container {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      font-size: 24px;
      color: white;
      display: flex;
      align-items: center;
      transition: transform 0.3s ease;
    }

    .cart-icon-container:hover {
      transform: scale(1.1);
    }

    .cart-count {
      background: #EA5455;
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 5px;
      position: relative;
      top: -8px;
      right: 5px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
      margin-top: 20px;
    }

    /* Shopping Cart Modal Styles */
    #cart {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      display: none;
      position: fixed;
      top: 80px;
      right: 15px;
      width: 90%;
      max-width: 400px;
      max-height: 70vh;
      overflow-y: auto;
      z-index: 1000;
      border: 1px solid #E0E0E0;
    }

    #cart.visible {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }

    .cart-header h2 {
      font-size: 1.3rem;
      color: #2D4059;
      font-weight: 700;
    }

    .close-cart {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 5px;
      transition: color 0.3s;
    }

    .close-cart:hover {
      color: #EA5455;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
      align-items: center;
      transition: background 0.2s;
    }

    .cart-item:hover {
      background: #F9F9F9;
    }

    .cart-item div:first-child {
      flex: 1;
    }

    .cart-item-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #2D4059;
    }

    .cart-item-price {
      color: #666;
      font-size: 0.9rem;
    }

    .cart-item-remove {
      background: #EA5455;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
    }

    .cart-item-remove:hover {
      background: #d33f3f;
      transform: translateY(-1px);
    }

    .wholesale-notification {
      background: #FFF9C4;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: center;
      border-left: 4px solid #FFD460;
    }

    .cart-total {
      text-align: right;
      font-weight: bold;
      margin: 15px 0;
      font-size: 1.1rem;
      padding-top: 10px;
      border-top: 1px solid #eee;
      color: #2D4059;
    }

    #checkout-btn {
      background: #008ca7;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(58, 99, 81, 0.3);
    }

    #checkout-btn:hover {
      background: #2e4f40;
      transform: translateY(-1px);
    }

    /* Brand Filter Menu */
    .brand-menu {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 15px;
      background: white;
      margin-bottom: 20px;
      scrollbar-width: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .brand-menu::-webkit-scrollbar {
      display: none;
    }

    .brand-btn {
      flex: 0 0 auto;
      padding: 10px 20px;
      border: none;
      background: #F2F2F2;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.3s;
      color: #393232;
    }

    .brand-btn.active {
      background: #008ca7;
      color: white;
      box-shadow: 0 2px 5px rgba(58, 99, 81, 0.3);
    }

    /* Product Grid */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .product-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
    }

    .product-image-container {
      height: 180px;
      background: #f8f8f8;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 12px 12px 0 0;
      position: relative;
    }

    .product-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      padding: 5px;
      transition: transform 0.5s ease;
    }

    .product-card:hover .product-image {
      transform: scale(1.05);
    }

    .product-watermark {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 8px 5px;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
      font-family: 'Nunito', sans-serif;
      font-size: 11px;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      pointer-events: none;
      max-height: 40%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .product-watermark div:first-child {
      font-weight: bold;
      font-size: 12px;
    }

    .product-details {
      padding: 16px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .product-text {
      flex-grow: 1;
    }

    .product-name {
      font-weight: 700;
      margin-bottom: 8px;
      font-size: 14px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 40px;
      color: #2D4059;
    }

    .product-actions {
      margin-top: auto;
    }

    .product-price {
      color: #2D4059;
      font-weight: bold;
      font-size: 16px;
      margin: 8px 0;
    }

    .wholesale-price {
      color: #00f633;
      font-size: 13px;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 600;
    }

    .add-to-cart {
      background: #008ca7;
      color: white !important;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(58, 99, 81, 0.2);
    }

    .add-to-cart:disabled {
      background: #cccccc !important;
      cursor: not-allowed !important;
      transform: none !important;
      box-shadow: none !important;
    }

    .add-to-cart:hover:not(:disabled) {
      background: #2e4f40;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(58, 99, 81, 0.3);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
      transition: backdrop-filter 0.3s ease;
    }

    .modal.visible {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      z-index: 1001;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .modal h3 {
      margin-bottom: 20px;
      color: #2D4059;
      font-size: 1.3rem;
    }

    .modal input, 
    .modal textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Nunito', sans-serif;
      transition: border 0.3s;
    }

    .modal input:focus, 
    .modal textarea:focus {
      border-color: #008ca7;
      outline: none;
      box-shadow: 0 0 0 2px rgba(58, 99, 81, 0.2);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 15px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    #confirm-customer{
      background: #4caf50;
      color: #f6f6f6;
    }

    #add-to-cart {
      background: #008ca7;
      color: white;
      box-shadow: 0 2px 5px rgba(58, 99, 81, 0.3);
    }

    #add-to-cart:hover {
      background: #2e4f40;
      transform: translateY(-1px);
    }

    #close-modal, #cancel-customer {
      background: #EA5455;
      color: white;
      box-shadow: 0 2px 5px rgba(234, 84, 85, 0.3);
    }

    #close-modal:hover, #cancel-customer:hover {
      background: #d33f3f;
      transform: translateY(-1px);
    }

    #customer-modal .modal-content {
      max-width: 500px;
    }

    #customer-modal label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2D4059;
    }

    /* Detail Modal Specific Styles */
    #detail-modal .modal-content {
      max-height: 80vh;
      overflow-y: auto;
      max-width: 500px;
      width: 90%;
    }

    .detail-description {
      max-height: 200px;
      overflow-y: auto;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 10px 0;
      white-space: pre-line;
      line-height: 1.5;
      border: 1px solid #eee;
    }

    .detail-description::-webkit-scrollbar {
      width: 6px;
    }

    .detail-description::-webkit-scrollbar-thumb {
      background: #008ca7;
      border-radius: 3px;
    }

    .detail-description::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    /* Marquee Styles */
    .marquee-container {
      overflow: hidden;
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 8px 0;
      font-weight: 500;
      white-space: nowrap;
      position: relative;
      margin-top: 5px;
      border-radius: 4px;
    }

    .marquee-text {
      display: inline-block;
      padding-left: 100%;
      animation: scroll-left 20s linear infinite;
    }

    @keyframes scroll-left {
      0% {
        transform: translateX(0%);
      }
      100% {
        transform: translateX(-100%);
      }
    }

    /* SweetAlert Custom Styles */
    .swal2-container {
      z-index: 99999 !important;
    }

    .swal2-popup {
      animation: fadeInUp 0.3s ease-out !important;
      border-radius: 12px !important;
      font-family: 'Nunito', sans-serif !important;
    }

    .swal2-title {
      color: #2D4059 !important;
      font-weight: 700 !important;
    }

    .swal2-toast {
      animation: fadeInUp 0.3s ease-out, fadeOut 0.5s ease-out 1.2s forwards !important;
      border-radius: 8px !important;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      to { opacity: 0; }
    }

    .swal2-timer-progress-bar {
      background: rgba(58, 99, 81, 0.4) !important;
    }

    /* Loading Indicator */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #008ca7;
      color: white;
      padding: 8px;
      text-align: center;
      z-index: 999;
      font-size: 14px;
      font-weight: 500;
      animation: pulse 1.5s infinite;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    @keyframes pulse {
      0% { opacity: 0.8; }
      50% { opacity: 1; }
      100% { opacity: 0.8; }
    }

    /* Auto-Refresh Notification */
    .refresh-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #008ca7;
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: opacity 0.5s;
      animation: slideUp 0.5s ease-out;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @keyframes slideUp {
      from { bottom: -50px; opacity: 0; }
      to { bottom: 20px; opacity: 1; }
    }

    /* Section Title */
    .section-title {
      font-size: 1.3rem;
      color: #2D4059;
      margin: 25px 0 15px 0;
      font-family: 'Barlow', sans-serif;
      border-bottom: 2px solid #008ca7;
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Responsive Grid */
    @media (min-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 992px) {
      .product-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 25px;
      }
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      #cart {
        width: 95%;
        right: 10px;
      }

      .cart-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .cart-item-remove {
        margin-top: 8px;
        align-self: flex-end;
      }

      .tab-btn, .brand-btn {
        padding: 8px 15px;
        font-size: 13px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .product-name {
        font-size: 13px;
      }
      
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <div class="header">
    <h1>MDR STORE</h1>
    <p>Solusi Belanja Digital Cepat & Terpercaya</p>
    <p id="timestamp" style="font-size: 0.8rem; color: rgba(255,255,255,0.8);"></p>
    <div class="marquee-container">
      <div class="marquee-text">
        🔥 Voucher Internet grosir? Min. 100 pcs, bebas mix produk! Gaskeun belanja hemat di MDR STORE! 🚀
      </div>
    </div>
    <!-- Cart Icon -->
    <div class="cart-icon-container" id="cart-icon">
      <i class="fas fa-shopping-cart"></i>
      <span id="cart-count" class="cart-count">0</span>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Category Tabs -->
    <h2 class="section-title">
      <i class="fas fa-list-ul"></i> Kategori Produk
    </h2>
    <div class="category-tabs" id="category-tabs">
      <!-- Will be filled dynamically -->
    </div>

    <!-- Brand Filter Menu -->
    <h2 class="section-title">
      <i class="fas fa-tags"></i> Brand
    </h2>
    <div class="brand-menu" id="brand-menu">
      <!-- Will be filled dynamically -->
    </div>

    <!-- Shopping Cart Modal -->
    <div id="cart">
      <div class="cart-header">
        <h2>Keranjang Belanja</h2>
        <button class="close-cart" id="close-cart">&times;</button>
      </div>
      <div id="cart-items"></div>
      <div class="wholesale-notification" id="wholesale-notice" style="display:none">
        Beli <span id="remaining-qty">97</span> pcs lagi dalam kategori <span id="wholesale-category">Voucher Internet</span> untuk dapat harga grosir!
      </div>
      <div class="cart-total">
        Total: Rp <span id="cart-total">0</span>
      </div>
      <button id="checkout-btn">Checkout via WhatsApp</button>
    </div>

    <!-- Product Grid -->
    <h2 class="section-title">
      <i class="fas fa-boxes"></i> Daftar Produk
    </h2>
    <div class="product-grid" id="product-grid"></div>
  </div>

  <!-- Quantity Modal -->
  <div class="modal" id="qty-modal">
    <div class="modal-content">
      <h3>Masukkan Jumlah</h3>
      <input type="number" id="qty-input" min="1" value="1">
      <div id="price-info" style="margin-bottom:15px"></div>
      <div class="modal-buttons">
        <button id="add-to-cart">Tambah ke Keranjang</button>
        <button id="close-modal">Batal</button>
      </div>
    </div>
  </div>

  <!-- Customer Data Modal -->
  <div class="modal" id="customer-modal">
    <div class="modal-content">
      <h3>Data Pemesan</h3>
      <div>
        <label for="customer-name">Nama Lengkap*</label>
        <input type="text" id="customer-name" required>
      </div>
      <div>
        <label for="customer-address">Alamat Lengkap*</label>
        <textarea id="customer-address" required rows="3"></textarea>
      </div>
      <div>
        <label for="customer-phone">No. WhatsApp*</label>
        <input type="tel" id="customer-phone" required>
      </div>
      <div class="modal-buttons">
        <button id="confirm-customer">Lanjutkan Checkout</button>
        <button id="cancel-customer">Batal</button>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading-indicator" class="loading-indicator" style="display:none">
    <i class="fas fa-sync-alt fa-spin"></i> Memperbarui data produk...
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>
  <script>
    /**
     * CONFIGURATION - UPDATED WITH AUTO-REFRESH SETTINGS
     */
    const CONFIG = {
      primarySheet: {
        id: '1Qn-UWBFxghJpBfRMXvtayXBxO5I3y5rHk-we0m2J9mU',
        sheetName: 'Sheet1',
        salesSheet: 'Penjualan',
        apiKey: 'AIzaSyAKnSVp0gz0TmQ6TUb-eLi6w96fyTtlIW8'
      },
      refreshInterval: 3600000, // 1 hour in milliseconds
      whatsappNumber: '6288988444888',
      cacheExpiry: 3600000 // 1 hour cache validity
    };

    /**
     * WHOLESALE RULES
     */
    const WHOLESALE_RULES = {
      "Voucher Internet": { minQty: 100, label: "Grosir (≥100)" },
      "Cable": { minQty: 2, label: "Grosir (≥2)" },
      "Charger": { minQty: 2, label: "Grosir (≥2)" },
      "Earphone": { minQty: 2, label: "Grosir (≥2)" },
      "TWS Bluetooth": { minQty: 2, label: "Grosir (≥2)" },
      "Bluetooth earphone": { minQty: 2, label: "Grosir (≥2)" },
      "Smart Watch": { minQty: 2, label: "Grosir (≥2)" },
      "Universal HUB": { minQty: 2, label: "Grosir (≥2)" },
      "Car Charger": { minQty: 2, label: "Grosir (≥2)" },
      "Power Bank": { minQty: 2, label: "Grosir (≥2)" },
      "Default": { minQty: 2, label: "Grosir (≥2)" }
    };

    /**
     * FALLBACK PRODUCTS
     */
    const fallbackProducts = [
      {
        kode: "TELKOMSEL-001",
        brand: "Telkomsel",
        kategori: "Voucher Internet",
        produk: "Voucher Telkomsel 10GB",
        deskripsi: "🟡 Kuota 10GB\n🟡 Masa berlaku 30 Hari\n🟡 Bisa untuk semua jaringan",
        harga: 50000,
        harga_grosir: 45000,
        gambar: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Indosat_Ooredoo_Hutchison.svg/960px-Indosat_Ooredoo_Hutchison.svg.png"
      },
      {
        kode: "XL-001",
        brand: "XL",
        kategori: "Voucher Internet",
        produk: "Voucher XL 5GB",
        deskripsi: "🟡 Kuota 5GB\n🟡 Masa berlaku 28 Hari\n🟡 Akses 24 jam",
        harga: 30000,
        harga_grosir: 27000,
        gambar: "https://example.com/wp-content/uploads/xl-voucher.jpg"
      }
    ];

    /**
     * SYSTEM VARIABLES
     */
    let products = [];
    let cart = [];
    let selectedProduct = null;
    let customerData = {
      name: '',
      address: '',
      phone: ''
    };
    let refreshTimer = null;

    /**
     * DOM ELEMENTS
     */
    const elements = {
      productGrid: document.getElementById('product-grid'),
      cartContainer: document.getElementById('cart'),
      cartItems: document.getElementById('cart-items'),
      cartTotal: document.getElementById('cart-total'),
      checkoutBtn: document.getElementById('checkout-btn'),
      cartIcon: document.getElementById('cart-icon'),
      cartCount: document.getElementById('cart-count'),
      closeCartBtn: document.getElementById('close-cart'),
      wholesaleNotice: document.getElementById('wholesale-notice'),
      remainingQty: document.getElementById('remaining-qty'),
      wholesaleCategory: document.getElementById('wholesale-category'),
      modals: {
        qty: document.getElementById('qty-modal'),
        customer: document.getElementById('customer-modal')
      },
      inputs: {
        qty: document.getElementById('qty-input'),
        customerName: document.getElementById('customer-name'),
        customerAddress: document.getElementById('customer-address'),
        customerPhone: document.getElementById('customer-phone')
      },
      buttons: {
        addToCart: document.getElementById('add-to-cart'),
        closeModal: document.getElementById('close-modal'),
        confirmCustomer: document.getElementById('confirm-customer'),
        cancelCustomer: document.getElementById('cancel-customer')
      },
      // Hidden filters for functionality
      categoryFilter: document.createElement('select'),
      brandFilter: document.createElement('select'),
      productFilter: document.createElement('input')
    };

    /**
     * UTILITY FUNCTIONS
     */
    const utils = {
      getWholesaleRule: (kategori) => WHOLESALE_RULES[kategori] || WHOLESALE_RULES["Default"],

      getTotalQtyByCategory: (cart, category) => {
        return cart.reduce((total, item) => item.kategori === category ? total + item.qty : total, 0);
      },

      formatProductName: (name) => {
        return name
          .replace(/(Oraimo|Baseus|Telkomsel)\s+/gi, '')
          .replace(/Model\s+\w+-\w+/i, '')
          .replace(/\s+/g, ' ')
          .trim();
      },

      getShortDescription: (desc) => {
        const points = desc.split('\n')
          .filter(line => line.trim().startsWith('🟡'))
          .slice(0, 2)
          .map(line => line.replace('🟡', '•').trim());
        return points.length > 0 ? points.join(' | ') : "Produk berkualitas MDR STORE";
      },

      formatCurrency: (amount) => {
        if(isNaN(amount)) return "0";
        return new Intl.NumberFormat('id-ID').format(amount);
      },

      validatePhone: (phone) => {
        const phoneRegex = /^[0-9]{10,15}$/;
        return phoneRegex.test(phone.replace(/\D/g, ''));
      },

      isCacheValid: () => {
        const lastCacheTime = localStorage.getItem('lastCacheTime');
        if (!lastCacheTime) return false;
        return (new Date().getTime() - parseInt(lastCacheTime)) < CONFIG.cacheExpiry;
      },

      validatePrice: (price) => {
        return price > 0 && !isNaN(price);
      },

      getCartItemCount: () => {
        return cart.reduce((total, item) => total + item.qty, 0);
      },

      activateMenuButton: (menuContainer, value) => {
        const buttons = menuContainer.querySelectorAll('.tab-btn, .brand-btn');
        buttons.forEach(button => {
          if (button.dataset.category === value || button.dataset.brand === value) {
            button.classList.add('active');
          } else {
            button.classList.remove('active');
          }
        });
      }
    };

    /**
     * DATA SERVICE
     */
    const dataService = {
      fetchPrimaryData: async () => {
        try {
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.primarySheet.id}/values/Sheet1!A1:K1000?key=${CONFIG.primarySheet.apiKey}`;

          const response = await fetch(url);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('Error dari Google Sheets API:', errorData.error.message);
            throw new Error(`Gagal mengambil data: ${errorData.error.message}`);
          }

          const data = await response.json();
          console.log('Data mentah dari Google Sheets:', data);

          if (!data.values || !Array.isArray(data.values)) {
            throw new Error('Format data tidak valid - tidak ada array values');
          }

          const headers = data.values[0];
          const processedData = data.values.slice(1).map(row => {
            const item = {};
            headers.forEach((header, index) => {
              const cleanHeader = header.trim();
              switch(cleanHeader) {
                case 'Kode Produk':
                  item.kode = row[index] || '';
                  break;
                case 'Brand':
                  item.brand = row[index] || '';
                  break;
                case 'Nama Kategori':
                  item.kategori = row[index] || '';
                  break;
                case 'Nama Produk':
                  item.produk = row[index] || '';
                  break;
                case 'Deskripsi':
                  item.deskripsi = row[index] || '-';
                  break;
                case 'Harga Retail':
                  item.harga = Math.max(0, parseInt((row[index] || '0').replace(/\D/g, ''))) || null;
                  break;
                case 'Harga Grosir':
                  item.harga_grosir = Math.max(0, parseInt((row[index] || '0').replace(/\D/g, ''))) || null;
                  break;
                case 'Gambar URL':
                  item.gambar = row[index] || '';
                  break;
              }
            });
            return item;
          });

          localStorage.setItem('cachedProducts', JSON.stringify(processedData));
          localStorage.setItem('lastCacheTime', new Date().getTime());
          return processedData;

        } catch (error) {
          console.error('Error dalam fetchPrimaryData:', error);
          return fallbackProducts;
        }
      },

      logTransaction: async (customer, items, total) => {
        try {
          const timestamp = new Date().toISOString();
          const transactionData = [
            timestamp,
            customer.name,
            customer.phone,
            customer.address,
            JSON.stringify(items),
            total,
            'Pending'
          ];

          const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.primarySheet.id}/values/${CONFIG.primarySheet.salesSheet}:append?valueInputOption=USER_ENTERED&key=${CONFIG.primarySheet.apiKey}`;

          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              values: [transactionData]
            })
          });

          if (!response.ok) {
            const error = await response.json();
            console.error('Gagal menyimpan transaksi:', error);
            return false;
          }

          console.log('Transaksi berhasil dicatat');
          return true;

        } catch (error) {
          console.error('Error saat mencatat transaksi:', error);
          return false;
        }
      },

      getCachedProducts: () => {
        if (!utils.isCacheValid()) return null;

        const cachedData = localStorage.getItem('cachedProducts');
        if (cachedData) {
          try {
            return JSON.parse(cachedData);
          } catch (e) {
            console.error('Error parsing cached products', e);
            return null;
          }
        }
        return null;
      },

      loadProducts: async () => {
        document.getElementById('loading-indicator').style.display = 'block';
        elements.checkoutBtn.disabled = true;

        // Check cache only if not expired
        if (utils.isCacheValid()) {
          const cachedProducts = dataService.getCachedProducts();
          if (cachedProducts) {
            products = cachedProducts;
            ui.createCategoryTabs();
            ui.updateBrandMenu();
            ui.renderProducts();
          }
        }

        try {
          const rawData = await dataService.fetchPrimaryData();
          products = rawData || fallbackProducts;
          
          // Save to cache with timestamp
          localStorage.setItem('cachedProducts', JSON.stringify(products));
          localStorage.setItem('lastCacheTime', new Date().getTime());

          ui.createCategoryTabs();
          ui.updateBrandMenu();
          ui.renderProducts();

        } catch (error) {
          console.error('Error loading products:', error);
          products = fallbackProducts;
          ui.createCategoryTabs();
          ui.updateBrandMenu();
          ui.renderProducts();
        } finally {
          document.getElementById('loading-indicator').style.display = 'none';
          elements.checkoutBtn.disabled = false;
          
          // Schedule next auto-refresh
          refreshTimer = setTimeout(dataService.loadProducts, CONFIG.refreshInterval);
        }
      },

      startAutoRefresh: () => {
        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(() => {
          ui.showAutoRefreshNotification();
          dataService.loadProducts();
        }, CONFIG.refreshInterval);
      }
    };

    /**
     * UI FUNCTIONS
     */
    const ui = {
      createCategoryTabs: () => {
        const tabsContainer = document.getElementById('category-tabs');
        tabsContainer.innerHTML = '';
        
        // Initialize hidden category filter
        elements.categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
        
        // Get all unique categories
        const categories = ["Semua", ...new Set(products.map(p => p.kategori))];
        
        categories.forEach(category => {
          // Add to visible tabs
          const tab = document.createElement('button');
          tab.className = 'tab-btn';
          tab.textContent = category;
          tab.dataset.category = category === "Semua" ? "" : category;
          
          if(category === "Semua") tab.classList.add('active');
          
          tab.addEventListener('click', () => {
            utils.activateMenuButton(tabsContainer, tab.dataset.category);
            elements.categoryFilter.value = tab.dataset.category;
            ui.updateBrandMenu();
            ui.renderProducts();
          });
          
          tabsContainer.appendChild(tab);
          
          // Add to hidden filter
          if(category !== "Semua") {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            elements.categoryFilter.appendChild(option);
          }
        });
      },

      updateBrandMenu: () => {
        const brandMenu = document.getElementById('brand-menu');
        brandMenu.innerHTML = '';
        
        // Initialize hidden brand filter
        elements.brandFilter.innerHTML = '<option value="">Semua Brand</option>';
        
        const selectedCategory = elements.categoryFilter.value;
        let filteredProducts = selectedCategory
          ? products.filter(p => p.kategori === selectedCategory)
          : products;
          
        const brands = ["Semua", ...new Set(filteredProducts.map(p => p.brand))];
        
        brands.forEach(brand => {
          // Add to visible menu
          const btn = document.createElement('button');
          btn.className = 'brand-btn';
          btn.textContent = brand;
          btn.dataset.brand = brand === "Semua" ? "" : brand;
          
          if(brand === "Semua") btn.classList.add('active');
          
          btn.addEventListener('click', () => {
            utils.activateMenuButton(brandMenu, btn.dataset.brand);
            elements.brandFilter.value = btn.dataset.brand;
            ui.renderProducts();
          });
          
          brandMenu.appendChild(btn);
          
          // Add to hidden filter
          if(brand !== "Semua") {
            const option = document.createElement('option');
            option.value = brand;
            option.textContent = brand;
            elements.brandFilter.appendChild(option);
          }
        });
      },

      renderProducts: () => {
        elements.productGrid.innerHTML = '';

        const selectedCategory = elements.categoryFilter.value;
        const selectedBrand = elements.brandFilter.value;
        const searchTerm = elements.productFilter.value.toLowerCase();

        let filteredProducts = products.filter(p => {
          const matchesCategory = !selectedCategory || p.kategori === selectedCategory;
          const matchesBrand = !selectedBrand || p.brand === selectedBrand;
          const matchesSearch = !searchTerm || 
            p.produk.toLowerCase().includes(searchTerm) || 
            utils.formatProductName(p.produk).toLowerCase().includes(searchTerm) ||
            p.kode.toLowerCase().includes(searchTerm);

          return matchesCategory && matchesBrand && matchesSearch;
        });

        if (filteredProducts.length === 0) {
          elements.productGrid.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; padding:20px;">
              <p>Tidak ada produk yang ditemukan</p>
              <button onclick="ui.resetFilters()" 
                style="background:#008ca7;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;margin-top:10px;font-weight:600;">
                Reset Filter
              </button>
            </div>
          `;
          return;
        }

        filteredProducts.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          const productName = utils.formatProductName(product.produk);
          const hasWholesale = product.harga_grosir !== null && utils.validatePrice(product.harga_grosir);
          const rule = utils.getWholesaleRule(product.kategori);
          const isPriceReady = utils.validatePrice(product.harga);

          card.innerHTML = `
            <div class="product-image-container">
              <img src="${product.gambar || 'https://via.placeholder.com/150?text=No+Image'}" 
                   alt="${productName}" class="product-image" loading="lazy">
              <div class="product-watermark">
                <div>Kode: ${product.kode}</div>
                ${utils.getShortDescription(product.deskripsi)}
              </div>
            </div>
            <div class="product-details">
              <div class="product-text">
                <div class="product-name">${productName}</div>
              </div>
              <div class="product-actions">
                <div class="product-price">
                  ${isPriceReady ? `Rp ${utils.formatCurrency(product.harga)}` : 
                    '<span style="color:#EA5455">Memuat harga...</span>'}
                </div>
                ${hasWholesale ? `
                  <div class="wholesale-price">${rule.label}: 
                    ${utils.validatePrice(product.harga_grosir) ? 
                      `Rp ${utils.formatCurrency(product.harga_grosir)}` : 'N/A'}
                  </div>
                ` : ''}
                <button class="add-to-cart" ${!isPriceReady ? 'disabled' : ''}>
                  ${isPriceReady ? '<i class="fas fa-cart-plus"></i> Keranjang' : 'Tunggu...'}
                </button>
              </div>
            </div>
          `;

          const addToCartBtn = card.querySelector('.add-to-cart');
          addToCartBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!utils.validatePrice(product.harga)) {
              Swal.fire({
                icon: 'error',
                title: 'Harga Belum Siap',
                text: 'Produk ini belum dapat dipesan. Harap tunggu sebentar...',
                timer: 2000
              });
              return;
            }
            selectedProduct = product;
            ui.showModal();
          });

          card.addEventListener('click', () => {
            ui.showProductDetail(product);
          });

          elements.productGrid.appendChild(card);
        });
      },

      resetFilters: () => {
        // Reset category
        elements.categoryFilter.value = '';
        const categoryTabs = document.getElementById('category-tabs');
        utils.activateMenuButton(categoryTabs, '');
        
        // Reset brand
        elements.brandFilter.value = '';
        const brandMenu = document.getElementById('brand-menu');
        utils.activateMenuButton(brandMenu, '');
        
        // Reset search
        elements.productFilter.value = '';
        
        ui.updateBrandMenu();
        ui.renderProducts();
      },

      showProductDetail: (product) => {
        const productName = utils.formatProductName(product.produk);
        const productDesc = product.deskripsi.replace(/(🟡)/g, '\n$1').trim();
        const hasWholesale = product.harga_grosir !== null && utils.validatePrice(product.harga_grosir);
        const rule = utils.getWholesaleRule(product.kategori);

        const detailModal = `
          <div class="modal visible" id="detail-modal">
            <div class="modal-content">
              <h3>${productName}</h3>
              <p><strong>Kode:</strong> ${product.kode}</p>
              <img src="${product.gambar || 'https://via.placeholder.com/150?text=No+Image'}" 
                   alt="${productName}" 
                   style="width:100%;max-height:200px;object-fit:contain;margin:10px 0;border-radius:8px;">
              
              <div class="detail-grid">
                <div><strong>Brand:</strong> ${product.brand}</div>
                <div><strong>Kategori:</strong> ${product.kategori}</div>
                <div><strong>Harga:</strong> Rp ${utils.validatePrice(product.harga) ? utils.formatCurrency(product.harga) : 'Memuat...'}</div>
                ${hasWholesale ? `
                  <div><strong>${rule.label}:</strong> Rp ${utils.formatCurrency(product.harga_grosir)}</div>
                ` : '<div></div>'}
              </div>
              
              <p><strong>Deskripsi:</strong></p>
              <div class="detail-description">
                ${productDesc}
              </div>
              
              <div class="modal-buttons">
                <button id="add-from-detail" style="background:#008ca7;color:white" ${!utils.validatePrice(product.harga) ? 'disabled' : ''}>
                  <i class="fas fa-cart-plus"></i> Tambah ke Keranjang
                </button>
                <button id="close-detail" style="background:#EA5455;color:white">
                  <i class="fas fa-times"></i> Tutup
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', detailModal);

        document.getElementById('close-detail').addEventListener('click', () => {
          document.getElementById('detail-modal').remove();
        });

        const addFromDetailBtn = document.getElementById('add-from-detail');
        if (addFromDetailBtn) {
          addFromDetailBtn.addEventListener('click', () => {
            if (!utils.validatePrice(product.harga)) {
              Swal.fire({
                icon: 'error',
                title: 'Harga Belum Siap',
                text: 'Produk ini belum dapat dipesan. Harap tunggu sebentar...',
                timer: 2000
              });
              return;
            }
            selectedProduct = product;
            document.getElementById('detail-modal').remove();
            ui.showModal();
          });
        }
      },

      showModal: () => {
        elements.inputs.qty.value = 1;
        elements.modals.qty.classList.add('visible');
        ui.updatePriceInfo();
        elements.inputs.qty.addEventListener('input', ui.updatePriceInfo);
      },

      updatePriceInfo: () => {
        const qty = parseInt(elements.inputs.qty.value) || 1;
        let price = selectedProduct.harga;
        let isWholesale = false;
        const rule = utils.getWholesaleRule(selectedProduct.kategori);
        const totalQtyInCart = utils.getTotalQtyByCategory(cart, selectedProduct.kategori);
        const totalQty = totalQtyInCart + qty;

        if (selectedProduct.harga_grosir !== null && totalQty >= rule.minQty) {
          price = selectedProduct.harga_grosir;
          isWholesale = true;
        }

        const total = price * qty;
        elements.priceInfo.innerHTML = `
          <div><strong>Harga Satuan:</strong> Rp ${utils.formatCurrency(price)} ${isWholesale ? '(Grosir)' : ''}</div>
          <div><strong>Total:</strong> Rp ${utils.formatCurrency(total)}</div>
          ${selectedProduct.harga_grosir !== null ? `
            <div style="margin-top:8px;font-size:12px;color:#666;padding:8px;background:#f5f5f5;border-radius:6px;">
              ${!isWholesale ? `Total ${totalQtyInCart} pcs di keranjang. Beli ${rule.minQty - totalQty} pcs lagi untuk dapat harga grosir!` : ''}
            </div>
          ` : ''}
        `;
      },

      hideModal: () => {
        elements.modals.qty.classList.remove('visible');
        elements.inputs.qty.removeEventListener('input', ui.updatePriceInfo);
      },

      updateCart: () => {
        elements.cartItems.innerHTML = '';

        if (cart.length === 0) {
          elements.cartContainer.classList.remove('visible');
          elements.cartCount.textContent = '0';
          elements.wholesaleNotice.style.display = 'none';
          return;
        }

        const categoriesInCart = [...new Set(cart.map(item => item.kategori))];
        let total = 0;
        let showWholesaleNotice = false;
        let noticeCategory = '';
        let remainingQty = 0;

        categoriesInCart.forEach(category => {
          const rule = utils.getWholesaleRule(category);
          const totalQty = utils.getTotalQtyByCategory(cart, category);
          const shouldApplyWholesale = totalQty >= rule.minQty;

          cart.forEach(item => {
            if (item.kategori === category && item.harga_grosir !== null) {
              item.harga = shouldApplyWholesale ? item.harga_grosir : item.harga;
              item.isWholesale = shouldApplyWholesale;

              if (!shouldApplyWholesale) {
                showWholesaleNotice = true;
                noticeCategory = category;
                remainingQty = rule.minQty - totalQty;
              }
            }
          });
        });

        cart.forEach((item, index) => {
          const subtotal = item.harga * item.qty;
          total += subtotal;

          const cartItem = document.createElement('div');
          cartItem.className = 'cart-item';
          cartItem.innerHTML = `
            <div>
              <div class="cart-item-name">${utils.formatProductName(item.produk)}</div>
              <div class="cart-item-price">${item.qty} x Rp ${utils.formatCurrency(item.harga)}</div>
              ${item.isWholesale ? `<div style="color:#008ca7;font-size:12px;font-weight:600;">(Harga Grosir)</div>` : ''}
            </div>
            <button class="cart-item-remove" onclick="app.removeFromCart(${index})">
              <i class="fas fa-trash-alt"></i> Hapus
            </button>
          `;
          elements.cartItems.appendChild(cartItem);
        });

        if (showWholesaleNotice) {
          elements.remainingQty.textContent = remainingQty;
          elements.wholesaleCategory.textContent = noticeCategory;
          elements.wholesaleNotice.style.display = 'block';
        } else {
          elements.wholesaleNotice.style.display = 'none';
        }

        elements.cartTotal.textContent = utils.formatCurrency(total);
        elements.cartCount.textContent = utils.getCartItemCount();
      },

      toggleCart: () => {
        elements.cartContainer.classList.toggle('visible');
      },

      closeCart: () => {
        elements.cartContainer.classList.remove('visible');
      },

      checkout: () => {
        if (cart.length === 0) {
          Swal.fire({
            icon: 'error',
            title: 'Keranjang Kosong',
            text: 'Silahkan tambahkan produk terlebih dahulu',
            timer: 1500,
            showConfirmButton: false
          });
          return;
        }

        const hasInvalidPrice = cart.some(item => !utils.validatePrice(item.harga));
        if (hasInvalidPrice) {
          Swal.fire({
            icon: 'error',
            title: 'Harga Tidak Valid',
            text: 'Ada produk dengan harga tidak valid. Segarkan halaman dan coba lagi.',
            timer: 2000
          });
          return;
        }

        ui.showCustomerModal();
      },

      showCustomerModal: () => {
        elements.inputs.customerName.value = localStorage.getItem('customerName') || '';
        elements.inputs.customerAddress.value = localStorage.getItem('customerAddress') || '';
        elements.inputs.customerPhone.value = localStorage.getItem('customerPhone') || '';
        elements.modals.customer.classList.add('visible');
      },

      generateOrderMessage: () => {
        let message = `*PEMESANAN - MDR STORE*\n`;
        message += `=========================\n\n`;
        message += `*DATA PELANGGAN*\n`;
        message += `- Nama: ${customerData.name}\n`;
        message += `- Alamat: ${customerData.address}\n`;
        message += `- WhatsApp: ${customerData.phone}\n\n`;

        message += `*DETAIL PESANAN*\n`;
        const categories = [...new Set(cart.map(item => item.kategori))];
        let totalPayment = 0;

        categories.forEach(category => {
          const categoryItems = cart.filter(item => item.kategori === category);
          const rule = utils.getWholesaleRule(category);
          const totalQty = utils.getTotalQtyByCategory(cart, category);

          message += `${category.toUpperCase()} (Total: ${totalQty} pcs${totalQty >= rule.minQty ? ' - HARGA GROSIR' : ''})\n`;
          categoryItems.forEach((item, index) => {
            message += `${index + 1}. ${utils.formatProductName(item.produk)}\n`;
            message += `   • Jumlah: ${item.qty} pcs\n`;
            message += `   • Harga: Rp ${utils.formatCurrency(item.harga)}${item.isWholesale ? ' (Grosir)' : ''}\n`;
            message += `   • Subtotal: Rp ${utils.formatCurrency(item.qty * item.harga)}\n\n`;
            totalPayment += item.qty * item.harga;
          });
        });

        message += `*TOTAL: Rp ${utils.formatCurrency(totalPayment)}*\n\n`;
        message += ` - Mohon berikan nomor rekening untuk pembayaran.\n`;

        return { message, total: totalPayment };
      },

      showAutoRefreshNotification: () => {
        const notif = document.createElement('div');
        notif.className = 'refresh-notification';
        notif.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Memperbarui data produk...';
        document.body.appendChild(notif);
        
        setTimeout(() => {
          notif.style.opacity = '0';
          setTimeout(() => notif.remove(), 500);
        }, 2000);
      }
    };

    /**
     * CORE APPLICATION
     */
    const app = {
      addToCart: () => {
        const qty = parseInt(elements.inputs.qty.value) || 1;

        if (!utils.validatePrice(selectedProduct.harga)) {
          Swal.fire({
            icon: 'error',
            title: 'Gagal',
            text: 'Harga produk tidak valid. Segarkan halaman dan coba lagi.',
            timer: 2000
          });
          return;
        }

        if (qty > 0 && selectedProduct) {
          const rule = utils.getWholesaleRule(selectedProduct.kategori);
          const totalQtyInCategory = utils.getTotalQtyByCategory(cart, selectedProduct.kategori) + qty;
          const isWholesale = totalQtyInCategory >= rule.minQty && utils.validatePrice(selectedProduct.harga_grosir);
          const price = isWholesale ? selectedProduct.harga_grosir : selectedProduct.harga;

          const existingItemIndex = cart.findIndex(item =>
            item.produk === selectedProduct.produk &&
            item.harga === price
          );

          if (existingItemIndex >= 0) {
            cart[existingItemIndex].qty += qty;
          } else {
            cart.push({
              ...selectedProduct,
              harga: price,
              qty: qty,
              isWholesale: isWholesale
            });
          }

          ui.updateCart();
          ui.hideModal();

          const notification = Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: `${qty} ${utils.formatProductName(selectedProduct.produk)} telah ditambahkan ke keranjang`,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 1500,
            timerProgressBar: true,
            background: '#008ca7',
            color: 'white'
          });
        }
      },

      removeFromCart: (index) => {
        cart.splice(index, 1);
        ui.updateCart();
      },

      processCheckout: async () => {
        const name = elements.inputs.customerName.value.trim();
        const address = elements.inputs.customerAddress.value.trim();
        const phone = elements.inputs.customerPhone.value.trim();

        if (!name || !address || !phone) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Harap lengkapi semua data pemesan!',
            timer: 2000,
            showConfirmButton: false
          });
          return;
        }

        if (!utils.validatePhone(phone)) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Nomor WhatsApp tidak valid! Harap masukkan 10-15 digit nomor.',
            timer: 2000,
            showConfirmButton: false
          });
          return;
        }

        localStorage.setItem('customerName', name);
        localStorage.setItem('customerAddress', address);
        localStorage.setItem('customerPhone', phone);

        customerData = { name, address, phone };

        const { message, total } = ui.generateOrderMessage();
        const whatsappUrl = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(message)}`;

        // Simpan transaksi ke Google Sheets
        const logSuccess = await dataService.logTransaction(customerData, cart, total);

        if (!logSuccess) {
          Swal.fire({
            icon: 'warning',
            title: 'Peringatan',
            text: 'Transaksi berhasil tapi gagal disimpan di database',
            timer: 2000
          });
        }

        window.open(whatsappUrl, '_blank');

        cart = [];
        ui.updateCart();
        elements.modals.customer.classList.remove('visible');

        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: 'Pesanan berhasil dibuat! Silahkan lanjutkan pembayaran via WhatsApp.',
          confirmButtonText: 'Oke',
          confirmButtonColor: '#008ca7'
        });
      },

      init: () => {
        // Initialize hidden filters
        elements.categoryFilter.id = 'category-filter';
        elements.brandFilter.id = 'brand-filter';
        elements.productFilter.id = 'product-filter';
        elements.productFilter.type = 'text';
        elements.productFilter.placeholder = 'Cari produk...';
        
        document.body.appendChild(elements.categoryFilter);
        document.body.appendChild(elements.brandFilter);
        document.body.appendChild(elements.productFilter);
        
        elements.categoryFilter.style.display = 'none';
        elements.brandFilter.style.display = 'none';
        elements.productFilter.style.display = 'none';

        // Set up event listeners
        elements.productFilter.addEventListener('input', () => {
          ui.renderProducts();
        });

        elements.buttons.addToCart.addEventListener('click', app.addToCart);
        elements.buttons.closeModal.addEventListener('click', ui.hideModal);
        elements.checkoutBtn.addEventListener('click', ui.checkout);
        elements.buttons.confirmCustomer.addEventListener('click', app.processCheckout);
        elements.buttons.cancelCustomer.addEventListener('click', () => {
          elements.modals.customer.classList.remove('visible');
        });

        elements.cartIcon.addEventListener('click', ui.toggleCart);
        elements.closeCartBtn.addEventListener('click', ui.closeCart);

        window.removeFromCart = app.removeFromCart;
        
        // Load products and start auto-refresh
        dataService.loadProducts();
        dataService.startAutoRefresh();

        // Load saved customer data if exists
        const savedName = localStorage.getItem('customerName');
        if (savedName) {
          customerData.name = savedName;
          elements.inputs.customerName.value = savedName;
        }
      }
    };

    // Set timestamp
    const timestampElement = document.getElementById("timestamp");
    const now = new Date();
    const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    timestampElement.innerText = `Terakhir diperbarui: ${timestamp}`;

    // Start the application when DOM is ready
    document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>
</html>