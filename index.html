<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Produk - MDR Pulsa</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --bg-color: #f1f5f9;
      --text-color: #1E293B;
      --card-bg: #ffffff;
      --card-text: #1E293B;
      --secondary-text: #6c757d;
      --border-color: #dee2e6;
    }
    [data-theme="dark"] {
      --bg-color: #0f172a;
      --text-color: #f8fafc;
      --card-bg: #1e293b;
      --card-text: #f8fafc;
      --secondary-text: #94a3b8;
      --border-color: #334155;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
    }
    .category-title { margin: 40px 0 20px; font-size: 24px; font-weight: bold; color: var(--text-color); }
    .card-product { transition: transform 0.2s; background: var(--card-bg); color: var(--card-text); }
    .card-product:hover { transform: translateY(-5px); }
    .card-product .card-text { color: var(--secondary-text); }
    .table, .table-bordered { color: var(--text-color); border-color: var(--border-color); }
    .table th, .table td { border-color: var(--border-color) !important; }
    .table thead { background: var(--card-bg); }
  </style>
</head>
<body>

<div class="container py-4">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold">Dashboard Produk</h1>
    <div class="d-flex align-items-center gap-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="themeSwitch">
        <label class="form-check-label text-secondary" for="themeSwitch">Mode Gelap</label>
      </div>
      <div class="text-secondary">Halo, User</div>
    </div>
  </header>

  <!-- Keranjang Belanja -->
  <div id="cart" class="card shadow-sm p-4 mb-5" style="display: none;">
    <h2 class="card-title mb-3">Keranjang Belanja (Invoice)</h2>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Produk</th>
            <th>Jumlah</th>
            <th>Harga Satuan</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="cartItems"></tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between fw-bold fs-5 mt-3">
      <span>Total:</span>
      <span id="cartTotal">Rp 0</span>
    </div>
    <button class="btn btn-dark mt-4 w-100" id="checkoutButton">Checkout via WhatsApp</button>
  </div>

  <!-- Controls -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Cari produk...">
    </div>
    <div class="col-md-4">
      <select id="brandFilter" class="form-select">
        <option value="">Semua Brand</option>
      </select>
    </div>
    <div class="col-md-4">
      <select id="categoryFilter" class="form-select">
        <option value="">Semua Kategori</option>
      </select>
    </div>
    <div class="col-md-4">
      <select id="sortPrice" class="form-select">
        <option value="">Urutkan Harga</option>
        <option value="asc">Termurah</option>
        <option value="desc">Termahal</option>
      </select>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loading" class="text-center my-5" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Produk -->
  <section id="categories" class="categories"></section>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const SHEET_URL = 'https://opensheet.vercel.app/1Qn-UWBFxghJpBfRMXvtayXBxO5I3y5rHk-we0m2J9mU/Sheet1';
let allProducts = [];
let filteredProducts = [];
let cart = [];

async function fetchProducts() {
  document.getElementById('loading').style.display = 'block';
  try {
    const res = await fetch(SHEET_URL);
    const data = await res.json();
    allProducts = data;
    filteredProducts = [...allProducts];
    populateFilters(allProducts);
    renderCategories(groupByCategory(filteredProducts));
  } catch (err) {
    console.error('Gagal load data:', err);
    document.getElementById('categories').innerHTML = '<p class="text-danger">Gagal memuat produk.</p>';
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

function groupByCategory(products) {
  const categories = {};
  products.forEach(item => {
    const kategori = item['Nama Kategori'] || 'Lainnya';
    if (!categories[kategori]) categories[kategori] = [];
    categories[kategori].push(item);
  });
  return categories;
}

function renderCategories(categories) {
  const container = document.getElementById('categories');
  container.innerHTML = '';

  for (const kategori in categories) {
    const group = document.createElement('div');
    group.className = 'category-group';
    group.innerHTML = `<h2 class="category-title">${kategori}</h2>`;

    const productsGrid = document.createElement('div');
    productsGrid.className = 'row g-4';

    categories[kategori].forEach(product => {
      const card = document.createElement('div');
      card.className = 'col-md-3';
      card.innerHTML = `
        <div class="card card-product h-100 shadow-sm">
          <img src="https://drive.google.com/uc?export=view&id=${product['Gambar']}" class="card-img-top" alt="${product['Nama Produk']}">
          <div class="card-body text-center">
            <h5 class="card-title">${product['Nama Produk']}</h5>
            <p class="card-text small">${product['Deskripsi']}</p>
            <p class="fw-bold">Rp ${formatRupiah(product['Harga'])}</p>
            <button class="btn btn-primary w-100" onclick="addToCart(${product['ID']})">Tambah ke Keranjang</button>
          </div>
        </div>
      `;
      productsGrid.appendChild(card);
    });

    group.appendChild(productsGrid);
    container.appendChild(group);
  }
}

function formatRupiah(angka) {
  if (!angka) return '0';
  return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function populateFilters(products) {
  const brandSet = new Set();
  const kategoriSet = new Set();
  
  products.forEach(item => {
    brandSet.add(item['Brand']);
    kategoriSet.add(item['Nama Kategori']);
  });

  const brandSelect = document.getElementById('brandFilter');
  brandSet.forEach(brand => {
    const opt = document.createElement('option');
    opt.value = brand;
    opt.textContent = brand;
    brandSelect.appendChild(opt);
  });

  const kategoriSelect = document.getElementById('categoryFilter');
  kategoriSet.forEach(kat => {
    const opt = document.createElement('option');
    opt.value = kat;
    opt.textContent = kat;
    kategoriSelect.appendChild(opt);
  });
}

function applyFilters() {
  const searchKeyword = document.getElementById('searchInput').value.toLowerCase();
  const selectedBrand = document.getElementById('brandFilter').value;
  const selectedCategory = document.getElementById('categoryFilter').value;
  const sortOrder = document.getElementById('sortPrice').value;

  let result = [...allProducts];

  if (searchKeyword) {
    result = result.filter(p => p['Nama Produk'] && p['Nama Produk'].toLowerCase().includes(searchKeyword));
  }

  if (selectedBrand) {
    result = result.filter(p => p['Brand'] === selectedBrand);
  }

  if (selectedCategory) {
    result = result.filter(p => p['Nama Kategori'] === selectedCategory);
  }

  if (sortOrder) {
    result.sort((a, b) => {
      const priceA = parseInt(a['Harga']) || 0;
      const priceB = parseInt(b['Harga']) || 0;
      return sortOrder === 'asc' ? priceA - priceB : priceB - priceA;
    });
  }

  filteredProducts = result;
  renderCategories(groupByCategory(filteredProducts));
}

function addToCart(productId) {
  const product = allProducts.find(p => p['ID'] === productId);
  if (!product) return;

  const qty = prompt("Masukkan jumlah produk:", 1);
  if (!qty || isNaN(qty) || qty <= 0) {
    alert("Jumlah produk tidak valid!");
    return;
  }

  const cartItem = {
    ...product,
    qty: parseInt(qty),
    total: parseInt(product['Harga']) * parseInt(qty)
  };
  cart.push(cartItem);
  renderCart();
}

function renderCart() {
  const cartDiv = document.getElementById('cart');
  const cartItemsDiv = document.getElementById('cartItems');
  const cartTotalDiv = document.getElementById('cartTotal');

  cartItemsDiv.innerHTML = '';
  let total = 0;

  cart.forEach((item, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item['Nama Produk']}</td>
      <td>
        <div class="d-flex align-items-center justify-content-center gap-2">
          <button class="btn btn-sm btn-outline-secondary" onclick="decreaseQty(${index})">-</button>
          <span>${item.qty}</span>
          <button class="btn btn-sm btn-outline-secondary" onclick="increaseQty(${index})">+</button>
        </div>
      </td>
      <td>Rp ${formatRupiah(item['Harga'])}</td>
      <td class="d-flex justify-content-between align-items-center">
        <span>Rp ${formatRupiah(item.total)}</span>
        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeItem(${index})">üóëÔ∏è</button>
      </td>
    `;
    cartItemsDiv.appendChild(row);
    total += item.total;
  });

  cartTotalDiv.textContent = `Rp ${formatRupiah(total)}`;
  cartDiv.style.display = cart.length > 0 ? 'block' : 'none';
}

function increaseQty(index) {
  cart[index].qty += 1;
  cart[index].total = cart[index].qty * parseInt(cart[index]['Harga']);
  renderCart();
}

function decreaseQty(index) {
  if (cart[index].qty > 1) {
    cart[index].qty -= 1;
    cart[index].total = cart[index].qty * parseInt(cart[index]['Harga']);
  } else {
    cart.splice(index, 1);
  }
  renderCart();
}

function removeItem(index) {
  if (confirm('Hapus produk ini dari keranjang?')) {
    cart.splice(index, 1);
    renderCart();
  }
}

function generateCheckoutMessage() {
  let message = 'üßæ *Invoice Pemesanan Produk*\n\n';

  // Nama Konter (boleh dikosongkan)
  message += '*Nama Konter:* \n\n';

  // Menambahkan item produk ke dalam pesan
  cart.forEach(item => {
    message += `‚úÖ *${item['Nama Produk']}* ${item.qty} X @ Rp ${formatRupiah(item['Harga'])} : Rp ${formatRupiah(item.total)}\n`;
  });

  // Menghitung total pembayaran
  const total = cart.reduce((sum, item) => sum + item.total, 0);
  message += `\n*Total Pembayaran: Rp ${formatRupiah(total)}*\n\n`;

  // Ucapan terima kasih
  message += 'üí¨ Terima kasih telah berbelanja di MDR Pulsa!';

  return message;
}

document.getElementById('checkoutButton').addEventListener('click', () => {
  const message = generateCheckoutMessage();
  const phoneNumber = '6285134575758'; // Ganti dengan nomor WhatsApp yang sesuai
  const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
});

document.getElementById('checkoutButton').addEventListener('click', () => {
  const message = generateCheckoutMessage();
  const phoneNumber = '6285134575758'; // Ganti dengan nomor WhatsApp yang sesuai
  const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
});

document.getElementById('checkoutButton').addEventListener('click', () => {
  const message = generateCheckoutMessage();
  const phoneNumber = '6285134575758';
  const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
});

document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('brandFilter').addEventListener('change', applyFilters);
document.getElementById('categoryFilter').addEventListener('change', applyFilters);
document.getElementById('sortPrice').addEventListener('change', applyFilters);

fetchProducts();

// Theme Switch
const themeSwitch = document.getElementById('themeSwitch');
themeSwitch.addEventListener('change', () => {
  if (themeSwitch.checked) {
    document.documentElement.setAttribute('data-theme', 'dark');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
});
console.log(`Gambar URL: https://drive.google.com/uc?export=view&id=${product['Gambar']}`);
</script>

</body>
</html>
