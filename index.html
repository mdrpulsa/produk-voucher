<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog Produk - MDR STORE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css">
  <link rel="icon" type="image/png" href="https://mdrpulsadata.wordpress.com/wp-content/uploads/2025/05/logo-favicon-48-x-44-px.png">
  <style>
    /* Base Styles */
    @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@600&family=Nunito:wght@400;700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Nunito', sans-serif;
      background-color: #f4f4f4;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* Header Styles */
    .header {
      text-align: center;
      padding: 20px;
      background: linear-gradient(90deg, #006D82, #008CA7);
      color: white;
      margin-bottom: 20px;
      position: relative;
    }

    .header h1 {
      font-family: 'Barlow', sans-serif;
      font-size: 28px;
      margin-bottom: 5px;
    }

    /* Cart Icon Styles */
    .cart-icon-container {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      font-size: 24px;
      color: white;
      display: flex;
      align-items: center;
    }

    .cart-count {
      background: #ff5722;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 5px;
      position: relative;
      top: -8px;
      right: 5px;
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    /* Shopping Cart Modal Styles */
    #cart {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: none;
      position: fixed;
      top: 80px;
      right: 15px;
      width: 90%;
      max-width: 400px;
      max-height: 70vh;
      overflow-y: auto;
      z-index: 1000;
      border: 1px solid #e0e0e0;
    }

    #cart.visible {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }

    .cart-header h2 {
      font-size: 1.3rem;
      color: #008ca7;
    }

    .close-cart {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 5px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
      align-items: center;
    }

    .cart-item div:first-child {
      flex: 1;
    }

    .cart-item-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .cart-item-price {
      color: #666;
      font-size: 0.9rem;
    }

    .cart-item-remove {
      background: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .wholesale-notification {
      background: #FFF9C4;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 0.9rem;
      text-align: center;
    }

    .cart-total {
      text-align: right;
      font-weight: bold;
      margin: 15px 0;
      font-size: 1.1rem;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    #checkout-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 5px;
      margin-top: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: background 0.3s;
    }

    #checkout-btn:hover {
      background: #45a049;
    }

    /* Filter Section */
    .filter-section {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-section select, 
    .filter-section input {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      flex: 1;
      min-width: 150px;
    }

    /* Product Grid */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .product-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .product-card:hover {
      transform: translateY(-3px);
    }

    .product-image-container {
      height: 180px;
      background: #f8f8f8;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 8px 8px 0 0;
      position: relative;
    }

    .product-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      padding: 5px;
      transition: transform 0.5s ease;
    }

    .product-card:hover .product-image {
      transform: scale(1.05);
    }

    .product-watermark {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 8px 5px;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
      font-family: 'Nunito', sans-serif;
      font-size: 11px;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      pointer-events: none;
      max-height: 40%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .product-watermark div:first-child {
      font-weight: bold;
      font-size: 12px;
    }

    .product-details {
      padding: 12px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .product-text {
      flex-grow: 1;
    }

    .product-name {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 13px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 40px;
    }

    .product-actions {
      margin-top: auto;
    }

    .product-price {
      color: #008ca7;
      font-weight: bold;
      font-size: 16px;
      margin: 8px 0;
    }

    .wholesale-price {
      color: #4CAF50;
      font-size: 13px;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .add-to-cart {
      background: #008ca7;
      color: white !important;
      border: none;
      padding: 8px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .add-to-cart:disabled {
      background: #cccccc !important;
      cursor: not-allowed !important;
    }

    .add-to-cart:hover:not(:disabled) {
      background: #006d82;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }

    .modal.visible {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }

    .modal h3 {
      margin-bottom: 15px;
    }

    .modal input, 
    .modal textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #008CA7;
      color:white;
    }

    #add-to-cart {
      background: #008ca7;
      color: white;
    }

    #close-modal {
      background: #f44336;
      color: white;
    }

    #cancel-customer {
      background: #f44336;
      color: white;
    }

    #customer-modal .modal-content {
      max-width: 500px;
    }

    #customer-modal label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    /* Responsive Grid */
    @media (min-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 992px) {
      .product-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Marquee Styles */
    .marquee-container {
      overflow: hidden;
      background-color: transparent;
      color: #fff;
      padding: 6px 0;
      font-weight: bold;
      white-space: nowrap;
      position: relative;
    }

    .marquee-text {
      display: inline-block;
      padding-left: 100%;
      animation: scroll-left 20s linear infinite;
    }

    @keyframes scroll-left {
      0% {
        transform: translateX(0%);
      }
      100% {
        transform: translateX(-100%);
      }
    }

    /* SweetAlert Custom Styles */
    .swal2-container {
      z-index: 99999 !important;
    }

    .swal2-popup {
      animation: fadeInUp 0.3s ease-out !important;
      border-radius: 12px !important;
    }

    .swal2-toast {
      animation: fadeInUp 0.3s ease-out, fadeOut 0.5s ease-out 1.2s forwards !important;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      to { opacity: 0; }
    }

    .swal2-timer-progress-bar {
      background: rgba(0,0,0,0.2) !important;
    }

    /* Loading Indicator */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #008ca7;
      color: white;
      padding: 5px;
      text-align: center;
      z-index: 999;
      font-size: 14px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    /* Auto-Refresh Notification */
    .refresh-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #008ca7;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: opacity 0.5s;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { bottom: -50px; opacity: 0; }
      to { bottom: 20px; opacity: 1; }
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      #cart {
        width: 95%;
        right: 10px;
      }

      .cart-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .cart-item-remove {
        margin-top: 8px;
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <div class="header">
    <h1>MDR STORE</h1>
    <p>Solusi Belanja Digital Cepat & Terpercaya</p>
    <p id="timestamp" style="font-size: 0.8rem; color: #ffffff;"></p>
    <div class="marquee-container">
      <div class="marquee-text">
        ðŸ”¥ Voucher Internet grosir? Min. 100 pcs, bebas mix produk! Gaskeun belanja hemat di MDR STORE! ðŸš€
      </div>
    </div>
    <!-- Cart Icon -->
    <div class="cart-icon-container" id="cart-icon">
      <i class="fas fa-shopping-cart"></i>
      <span id="cart-count" class="cart-count">0</span>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Shopping Cart Modal -->
    <div id="cart">
      <div class="cart-header">
        <h2>Keranjang Belanja</h2>
        <button class="close-cart" id="close-cart">&times;</button>
      </div>
      <div id="cart-items"></div>
      <div class="wholesale-notification" id="wholesale-notice" style="display:none">
        Beli <span id="remaining-qty">97</span> pcs lagi dalam kategori <span id="wholesale-category">Voucher Internet</span> untuk dapat harga grosir!
      </div>
      <div class="cart-total">
        Total: Rp <span id="cart-total">0</span>
      </div>
      <button id="checkout-btn">Checkout via WhatsApp</button>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <select id="category-filter">
        <option value="">Semua Kategori</option>
      </select>
      <select id="brand-filter">
        <option value="">Semua Brand</option>
      </select>
      <input type="text" id="product-filter" placeholder="Cari nama produk...">
    </div>

    <!-- Product Grid -->
    <div class="product-grid" id="product-grid"></div>
  </div>

  <!-- Quantity Modal -->
  <div class="modal" id="qty-modal">
    <div class="modal-content">
      <h3>Masukkan Jumlah</h3>
      <input type="number" id="qty-input" min="1" value="1">
      <div id="price-info" style="margin-bottom:15px"></div>
      <div class="modal-buttons">
        <button id="add-to-cart">Tambah ke Keranjang</button>
        <button id="close-modal">Batal</button>
      </div>
    </div>
  </div>

  <!-- Customer Data Modal -->
  <div class="modal" id="customer-modal">
    <div class="modal-content">
      <h3>Data Pemesan</h3>
      <div>
        <label for="customer-name">Nama Lengkap*</label>
        <input type="text" id="customer-name" required>
      </div>
      <div>
        <label for="customer-address">Alamat Lengkap*</label>
        <textarea id="customer-address" required rows="3"></textarea>
      </div>
      <div>
        <label for="customer-phone">No. WhatsApp*</label>
        <input type="tel" id="customer-phone" required>
      </div>
      <div class="modal-buttons">
        <button id="confirm-customer">Lanjutkan Checkout</button>
        <button id="cancel-customer">Batal</button>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading-indicator" class="loading-indicator" style="display:none">
    Memperbarui data produk...
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>
  <script>
    /**
     * CONFIGURATION - UPDATED WITH AUTO-REFRESH SETTINGS
     */
    const CONFIG = {
      primarySheet: {
        id: '1Qn-UWBFxghJpBfRMXvtayXBxO5I3y5rHk-we0m2J9mU',
        sheetName: 'Sheet1',
        salesSheet: 'Penjualan',
        apiKey: 'AIzaSyAKnSVp0gz0TmQ6TUb-eLi6w96fyTtlIW8'
      },
      refreshInterval: 3600000, // 1 hour in milliseconds
      whatsappNumber: '6288988444888',
      cacheExpiry: 3600000 // 1 hour cache validity
    };

    /**
     * WHOLESALE RULES
     */
    const WHOLESALE_RULES = {
      "Voucher Internet": { minQty: 100, label: "Grosir (â‰¥100)" },
      "Kabel Data": { minQty: 2, label: "Grosir (â‰¥2)" },
      "Charger": { minQty: 2, label: "Grosir (â‰¥2)" },
      "Default": { minQty: 2, label: "Grosir (â‰¥2)" }
    };

    /**
     * FALLBACK PRODUCTS
     */
    const fallbackProducts = [
      {
        kode: "TELKOMSEL-001",
        brand: "Telkomsel",
        kategori: "Voucher Internet",
        produk: "Voucher Telkomsel 10GB",
        deskripsi: "ðŸŸ¡ Kuota 10GB\nðŸŸ¡ Masa berlaku 30 Hari\nðŸŸ¡ Bisa untuk semua jaringan",
        harga: 50000,
        harga_grosir: 45000,
        gambar: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Indosat_Ooredoo_Hutchison.svg/960px-Indosat_Ooredoo_Hutchison.svg.png"
      },
      {
        kode: "XL-001",
        brand: "XL",
        kategori: "Voucher Internet",
        produk: "Voucher XL 5GB",
        deskripsi: "ðŸŸ¡ Kuota 5GB\nðŸŸ¡ Masa berlaku 28 Hari\nðŸŸ¡ Akses 24 jam",
        harga: 30000,
        harga_grosir: 27000,
        gambar: "https://example.com/wp-content/uploads/xl-voucher.jpg"
      }
    ];

    /**
     * SYSTEM VARIABLES
     */
    let products = [];
    let cart = [];
    let selectedProduct = null;
    let customerData = {
      name: '',
      address: '',
      phone: ''
    };
    let refreshTimer = null;

    /**
     * DOM ELEMENTS
     */
    const elements = {
      brandFilter: document.getElementById('brand-filter'),
      categoryFilter: document.getElementById('category-filter'),
      productFilter: document.getElementById('product-filter'),
      productGrid: document.getElementById('product-grid'),
      cartContainer: document.getElementById('cart'),
      cartItems: document.getElementById('cart-items'),
      cartTotal: document.getElementById('cart-total'),
      checkoutBtn: document.getElementById('checkout-btn'),
      cartIcon: document.getElementById('cart-icon'),
      cartCount: document.getElementById('cart-count'),
      closeCartBtn: document.getElementById('close-cart'),
      wholesaleNotice: document.getElementById('wholesale-notice'),
      remainingQty: document.getElementById('remaining-qty'),
      wholesaleCategory: document.getElementById('wholesale-category'),
      modals: {
        qty: document.getElementById('qty-modal'),
        customer: document.getElementById('customer-modal')
      },
      inputs: {
        qty: document.getElementById('qty-input'),
        customerName: document.getElementById('customer-name'),
        customerAddress: document.getElementById('customer-address'),
        customerPhone: document.getElementById('customer-phone')
      },
      buttons: {
        addToCart: document.getElementById('add-to-cart'),
        closeModal: document.getElementById('close-modal'),
        confirmCustomer: document.getElementById('confirm-customer'),
        cancelCustomer: document.getElementById('cancel-customer')
      }
    };

    /**
     * UTILITY FUNCTIONS
     */
    const utils = {
      getWholesaleRule: (kategori) => WHOLESALE_RULES[kategori] || WHOLESALE_RULES["Default"],

      getTotalQtyByCategory: (cart, category) => {
        return cart.reduce((total, item) => item.kategori === category ? total + item.qty : total, 0);
      },

      formatProductName: (name) => {
        return name
          .replace(/(Oraimo|Baseus|Telkomsel)\s+/gi, '')
          .replace(/Model\s+\w+-\w+/i, '')
          .replace(/\s+/g, ' ')
          .trim();
      },

      getShortDescription: (desc) => {
        const points = desc.split('\n')
          .filter(line => line.trim().startsWith('ðŸŸ¡'))
          .slice(0, 2)
          .map(line => line.replace('ðŸŸ¡', 'â€¢').trim());
        return points.length > 0 ? points.join(' | ') : "Produk berkualitas MDR STORE";
      },

      formatCurrency: (amount) => {
        if(isNaN(amount)) return "0";
        return new Intl.NumberFormat('id-ID').format(amount);
      },

      validatePhone: (phone) => {
        const phoneRegex = /^[0-9]{10,15}$/;
        return phoneRegex.test(phone.replace(/\D/g, ''));
      },

      isCacheValid: () => {
        const lastCacheTime = localStorage.getItem('lastCacheTime');
        if (!lastCacheTime) return false;
        return (new Date().getTime() - parseInt(lastCacheTime)) < CONFIG.cacheExpiry;
      },

      validatePrice: (price) => {
        return price > 0 && !isNaN(price);
      },

      getCartItemCount: () => {
        return cart.reduce((total, item) => total + item.qty, 0);
      }
    };

    /**
     * DATA SERVICE
     */
    const dataService = {
      fetchPrimaryData: async () => {
        try {
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.primarySheet.id}/values/Sheet1!A1:K1000?key=${CONFIG.primarySheet.apiKey}`;

          const response = await fetch(url);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('Error dari Google Sheets API:', errorData.error.message);
            throw new Error(`Gagal mengambil data: ${errorData.error.message}`);
          }

          const data = await response.json();
          console.log('Data mentah dari Google Sheets:', data);

          if (!data.values || !Array.isArray(data.values)) {
            throw new Error('Format data tidak valid - tidak ada array values');
          }

          const headers = data.values[0];
          const processedData = data.values.slice(1).map(row => {
            const item = {};
            headers.forEach((header, index) => {
              const cleanHeader = header.trim();
              switch(cleanHeader) {
                case 'Kode Produk':
                  item.kode = row[index] || '';
                  break;
                case 'Brand':
                  item.brand = row[index] || '';
                  break;
                case 'Nama Kategori':
                  item.kategori = row[index] || '';
                  break;
                case 'Nama Produk':
                  item.produk = row[index] || '';
                  break;
                case 'Deskripsi':
                  item.deskripsi = row[index] || '-';
                  break;
                case 'Harga Retail':
                  item.harga = Math.max(0, parseInt((row[index] || '0').replace(/\D/g, ''))) || null;
                  break;
                case 'Harga Grosir':
                  item.harga_grosir = Math.max(0, parseInt((row[index] || '0').replace(/\D/g, ''))) || null;
                  break;
                case 'Gambar URL':
                  item.gambar = row[index] || '';
                  break;
              }
            });
            return item;
          });

          localStorage.setItem('cachedProducts', JSON.stringify(processedData));
          localStorage.setItem('lastCacheTime', new Date().getTime());
          return processedData;

        } catch (error) {
          console.error('Error dalam fetchPrimaryData:', error);
          return fallbackProducts;
        }
      },

      logTransaction: async (customer, items, total) => {
        try {
          const timestamp = new Date().toISOString();
          const transactionData = [
            timestamp,
            customer.name,
            customer.phone,
            customer.address,
            JSON.stringify(items),
            total,
            'Pending'
          ];

          const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.primarySheet.id}/values/${CONFIG.primarySheet.salesSheet}:append?valueInputOption=USER_ENTERED&key=${CONFIG.primarySheet.apiKey}`;

          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              values: [transactionData]
            })
          });

          if (!response.ok) {
            const error = await response.json();
            console.error('Gagal menyimpan transaksi:', error);
            return false;
          }

          console.log('Transaksi berhasil dicatat');
          return true;

        } catch (error) {
          console.error('Error saat mencatat transaksi:', error);
          return false;
        }
      },

      getCachedProducts: () => {
        if (!utils.isCacheValid()) return null;

        const cachedData = localStorage.getItem('cachedProducts');
        if (cachedData) {
          try {
            return JSON.parse(cachedData);
          } catch (e) {
            console.error('Error parsing cached products', e);
            return null;
          }
        }
        return null;
      },

      loadProducts: async () => {
        document.getElementById('loading-indicator').style.display = 'block';
        elements.checkoutBtn.disabled = true;

        // Check cache only if not expired
        if (utils.isCacheValid()) {
          const cachedProducts = dataService.getCachedProducts();
          if (cachedProducts) {
            products = cachedProducts;
            ui.updateFilters();
            ui.renderProducts();
          }
        }

        try {
          const rawData = await dataService.fetchPrimaryData();
          products = rawData || fallbackProducts;
          
          // Save to cache with timestamp
          localStorage.setItem('cachedProducts', JSON.stringify(products));
          localStorage.setItem('lastCacheTime', new Date().getTime());

          ui.updateFilters();
          ui.renderProducts();

        } catch (error) {
          console.error('Error loading products:', error);
          products = fallbackProducts;
          ui.updateFilters();
          ui.renderProducts();
        } finally {
          document.getElementById('loading-indicator').style.display = 'none';
          elements.checkoutBtn.disabled = false;
          
          // Schedule next auto-refresh
          refreshTimer = setTimeout(dataService.loadProducts, CONFIG.refreshInterval);
        }
      },

      startAutoRefresh: () => {
        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(() => {
          ui.showAutoRefreshNotification();
          dataService.loadProducts();
        }, CONFIG.refreshInterval);
      }
    };

    /**
     * UI FUNCTIONS
     */
    const ui = {
      updateFilters: () => {
        elements.categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
        [...new Set(products.map(p => p.kategori))].forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          elements.categoryFilter.appendChild(option);
        });
        ui.updateBrandFilter();
      },

      updateBrandFilter: () => {
        elements.brandFilter.innerHTML = '<option value="">Semua Brand</option>';
        const selectedCategory = elements.categoryFilter.value;
        let filteredProducts = selectedCategory
          ? products.filter(p => p.kategori === selectedCategory)
          : products;
        [...new Set(filteredProducts.map(p => p.brand))].forEach(brand => {
          const option = document.createElement('option');
          option.value = brand;
          option.textContent = brand;
          elements.brandFilter.appendChild(option);
        });
      },

      renderProducts: () => {
        elements.productGrid.innerHTML = '';

        const selectedCategory = elements.categoryFilter.value;
        const selectedBrand = elements.brandFilter.value;
        const searchTerm = elements.productFilter.value.toLowerCase();

        let filteredProducts = products.filter(p => {
          const matchesCategory = !selectedCategory || p.kategori === selectedCategory;
          const matchesBrand = !selectedBrand || p.brand === selectedBrand;
          const matchesSearch = !searchTerm || 
            p.produk.toLowerCase().includes(searchTerm) || 
            utils.formatProductName(p.produk).toLowerCase().includes(searchTerm) ||
            p.kode.toLowerCase().includes(searchTerm);

          return matchesCategory && matchesBrand && matchesSearch;
        });

        if (filteredProducts.length === 0) {
          elements.productGrid.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; padding:20px;">
              <p>Tidak ada produk yang ditemukan</p>
              <button onclick="elements.categoryFilter.value='';elements.brandFilter.value='';elements.productFilter.value='';ui.renderProducts()" 
                style="background:#008ca7;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;margin-top:10px;">
                Reset Filter
              </button>
            </div>
          `;
          return;
        }

        // Auto-refresh jika ada harga invalid
        const hasInvalidPrices = filteredProducts.some(p => !utils.validatePrice(p.harga));
        if (hasInvalidPrices) {
          setTimeout(dataService.loadProducts, 36000000);
        }

        filteredProducts.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          const productName = utils.formatProductName(product.produk);
          const hasWholesale = product.harga_grosir !== null && utils.validatePrice(product.harga_grosir);
          const rule = utils.getWholesaleRule(product.kategori);
          const isPriceReady = utils.validatePrice(product.harga);

          card.innerHTML = `
            <div class="product-image-container">
              <img src="${product.gambar || 'https://via.placeholder.com/150?text=No+Image'}" 
                   alt="${productName}" class="product-image" loading="lazy">
              <div class="product-watermark">
                <div>Kode: ${product.kode}</div>
                ${utils.getShortDescription(product.deskripsi)}
              </div>
            </div>
            <div class="product-details">
              <div class="product-text">
                <div class="product-name">${productName}</div>
              </div>
              <div class="product-actions">
                <div class="product-price">
                  ${isPriceReady ? `Rp ${utils.formatCurrency(product.harga)}` : 
                    '<span style="color:red">Memuat harga...</span>'}
                </div>
                ${hasWholesale ? `
                  <div class="wholesale-price">${rule.label}: 
                    ${utils.validatePrice(product.harga_grosir) ? 
                      `Rp ${utils.formatCurrency(product.harga_grosir)}` : 'N/A'}
                  </div>
                ` : ''}
                <button class="add-to-cart" ${!isPriceReady ? 'disabled' : ''}>
                  ${isPriceReady ? '+ Keranjang' : 'Tunggu...'}
                </button>
              </div>
            </div>
          `;

          const addToCartBtn = card.querySelector('.add-to-cart');
          addToCartBtn.addEventListener('click', (e) => {
            e.stopPropagation();

            if (!utils.validatePrice(product.harga)) {
              Swal.fire({
                icon: 'error',
                title: 'Harga Belum Siap',
                text: 'Produk ini belum dapat dipesan. Harap tunggu sebentar...',
                timer: 2000
              });
              return;
            }

            selectedProduct = product;
            ui.showModal();
          });

          card.addEventListener('click', () => {
            ui.showProductDetail(product);
          });

          elements.productGrid.appendChild(card);
        });
      },

      showProductDetail: (product) => {
        const productName = utils.formatProductName(product.produk);
        const productDesc = product.deskripsi.replace(/(ðŸŸ¡)/g, '\n$1').trim();
        const hasWholesale = product.harga_grosir !== null && utils.validatePrice(product.harga_grosir);
        const rule = utils.getWholesaleRule(product.kategori);

        const detailModal = `
          <div class="modal visible" id="detail-modal">
            <div class="modal-content" style="max-width:500px">
              <h3>${productName}</h3>
              <p><strong>Kode:</strong> ${product.kode}</p>
              <img src="${product.gambar || 'https://via.placeholder.com/150?text=No+Image'}" alt="${productName}" style="width:100%;max-height:200px;object-fit:contain;margin:10px 0">
              <p><strong>Brand:</strong> ${product.brand}</p>
              <p><strong>Kategori:</strong> ${product.kategori}</p>
              <p><strong>Harga:</strong> Rp ${utils.validatePrice(product.harga) ? utils.formatCurrency(product.harga) : 'Memuat...'}</p>
              ${hasWholesale ? `
                <p><strong>${rule.label}:</strong> Rp ${utils.formatCurrency(product.harga_grosir)}</p>
              ` : ''}
              <p><strong>Deskripsi:</strong></p>
              <p style="white-space: pre-line">${productDesc}</p>
              <div class="modal-buttons">
                <button id="add-from-detail" style="background:#008ca7;color:white" ${!utils.validatePrice(product.harga) ? 'disabled' : ''}>
                  Tambah ke Keranjang
                </button>
                <button id="close-detail" style="background:#f44336;color:white">Tutup</button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', detailModal);

        document.getElementById('close-detail').addEventListener('click', () => {
          document.getElementById('detail-modal').remove();
        });

        const addFromDetailBtn = document.getElementById('add-from-detail');
        if (addFromDetailBtn) {
          addFromDetailBtn.addEventListener('click', () => {
            if (!utils.validatePrice(product.harga)) {
              Swal.fire({
                icon: 'error',
                title: 'Harga Belum Siap',
                text: 'Produk ini belum dapat dipesan. Harap tunggu sebentar...',
                timer: 2000
              });
              return;
            }
            selectedProduct = product;
            document.getElementById('detail-modal').remove();
            ui.showModal();
          });
        }
      },

      showModal: () => {
        elements.inputs.qty.value = 1;
        elements.modals.qty.classList.add('visible');
        ui.updatePriceInfo();
        elements.inputs.qty.addEventListener('input', ui.updatePriceInfo);
      },

      updatePriceInfo: () => {
        const qty = parseInt(elements.inputs.qty.value) || 1;
        let price = selectedProduct.harga;
        let isWholesale = false;
        const rule = utils.getWholesaleRule(selectedProduct.kategori);
        const totalQtyInCart = utils.getTotalQtyByCategory(cart, selectedProduct.kategori);
        const totalQty = totalQtyInCart + qty;

        if (selectedProduct.harga_grosir !== null && totalQty >= rule.minQty) {
          price = selectedProduct.harga_grosir;
          isWholesale = true;
        }

        const total = price * qty;
        elements.priceInfo.innerHTML = `
          <div><strong>Harga Satuan:</strong> Rp ${utils.formatCurrency(price)} ${isWholesale ? '(Grosir)' : ''}</div>
          <div><strong>Total:</strong> Rp ${utils.formatCurrency(total)}</div>
          ${selectedProduct.harga_grosir !== null ? `
            <div style="margin-top:5px;font-size:12px;color:#666">
              ${!isWholesale ? `Total ${totalQtyInCart} pcs di keranjang. Beli ${rule.minQty - totalQty} pcs lagi untuk dapat harga grosir!` : ''}
            </div>
          ` : ''}
        `;
      },

      hideModal: () => {
        elements.modals.qty.classList.remove('visible');
        elements.inputs.qty.removeEventListener('input', ui.updatePriceInfo);
      },

      updateCart: () => {
        elements.cartItems.innerHTML = '';

        if (cart.length === 0) {
          elements.cartContainer.classList.remove('visible');
          elements.cartCount.textContent = '0';
          elements.wholesaleNotice.style.display = 'none';
          return;
        }

        const categoriesInCart = [...new Set(cart.map(item => item.kategori))];
        let total = 0;
        let showWholesaleNotice = false;
        let noticeCategory = '';
        let remainingQty = 0;

        categoriesInCart.forEach(category => {
          const rule = utils.getWholesaleRule(category);
          const totalQty = utils.getTotalQtyByCategory(cart, category);
          const shouldApplyWholesale = totalQty >= rule.minQty;

          cart.forEach(item => {
            if (item.kategori === category && item.harga_grosir !== null) {
              item.harga = shouldApplyWholesale ? item.harga_grosir : item.harga;
              item.isWholesale = shouldApplyWholesale;

              if (!shouldApplyWholesale) {
                showWholesaleNotice = true;
                noticeCategory = category;
                remainingQty = rule.minQty - totalQty;
              }
            }
          });
        });

        cart.forEach((item, index) => {
          const subtotal = item.harga * item.qty;
          total += subtotal;

          const cartItem = document.createElement('div');
          cartItem.className = 'cart-item';
          cartItem.innerHTML = `
            <div>
              <div class="cart-item-name">${utils.formatProductName(item.produk)}</div>
              <div class="cart-item-price">${item.qty} x Rp ${utils.formatCurrency(item.harga)}</div>
              ${item.isWholesale ? `<div style="color:#4CAF50;font-size:12px">(Harga Grosir)</div>` : ''}
            </div>
            <button class="cart-item-remove" onclick="app.removeFromCart(${index})">Hapus</button>
          `;
          elements.cartItems.appendChild(cartItem);
        });

        if (showWholesaleNotice) {
          elements.remainingQty.textContent = remainingQty;
          elements.wholesaleCategory.textContent = noticeCategory;
          elements.wholesaleNotice.style.display = 'block';
        } else {
          elements.wholesaleNotice.style.display = 'none';
        }

        elements.cartTotal.textContent = utils.formatCurrency(total);
        elements.cartCount.textContent = utils.getCartItemCount();
      },

      toggleCart: () => {
        elements.cartContainer.classList.toggle('visible');
      },

      closeCart: () => {
        elements.cartContainer.classList.remove('visible');
      },

      checkout: () => {
        if (cart.length === 0) {
          Swal.fire({
            icon: 'error',
            title: 'Keranjang Kosong',
            text: 'Silahkan tambahkan produk terlebih dahulu',
            timer: 1500,
            showConfirmButton: false
          });
          return;
        }

        const hasInvalidPrice = cart.some(item => !utils.validatePrice(item.harga));
        if (hasInvalidPrice) {
          Swal.fire({
            icon: 'error',
            title: 'Harga Tidak Valid',
            text: 'Ada produk dengan harga tidak valid. Segarkan halaman dan coba lagi.',
            timer: 2000
          });
          return;
        }

        ui.showCustomerModal();
      },

      showCustomerModal: () => {
        elements.inputs.customerName.value = localStorage.getItem('customerName') || '';
        elements.inputs.customerAddress.value = localStorage.getItem('customerAddress') || '';
        elements.inputs.customerPhone.value = localStorage.getItem('customerPhone') || '';
        elements.modals.customer.classList.add('visible');
      },

      generateOrderMessage: () => {
        let message = `*PEMESANAN - MDR STORE*\n`;
        message += `=========================\n\n`;
        message += `*DATA PELANGGAN*\n`;
        message += `- Nama: ${customerData.name}\n`;
        message += `- Alamat: ${customerData.address}\n`;
        message += `- WhatsApp: ${customerData.phone}\n\n`;

        message += `*DETAIL PESANAN*\n`;
        const categories = [...new Set(cart.map(item => item.kategori))];
        let totalPayment = 0;

        categories.forEach(category => {
          const categoryItems = cart.filter(item => item.kategori === category);
          const rule = utils.getWholesaleRule(category);
          const totalQty = utils.getTotalQtyByCategory(cart, category);

          message += `${category.toUpperCase()} (Total: ${totalQty} pcs${totalQty >= rule.minQty ? ' - HARGA GROSIR' : ''})\n`;
          categoryItems.forEach((item, index) => {
            message += `${index + 1}. ${utils.formatProductName(item.produk)}\n`;
            message += `   â€¢ Jumlah: ${item.qty} pcs\n`;
            message += `   â€¢ Harga: Rp ${utils.formatCurrency(item.harga)}${item.isWholesale ? ' (Grosir)' : ''}\n`;
            message += `   â€¢ Subtotal: Rp ${utils.formatCurrency(item.qty * item.harga)}\n\n`;
            totalPayment += item.qty * item.harga;
          });
        });

        message += `*TOTAL: Rp ${utils.formatCurrency(totalPayment)}*\n\n`;
        message += ` - Mohon berikan nomor rekening untuk pembayaran.\n`;

        return { message, total: totalPayment };
      },

      showAutoRefreshNotification: () => {
        const notif = document.createElement('div');
        notif.className = 'refresh-notification';
        notif.innerHTML = '<i class="fas fa-sync-alt"></i> Memperbarui data produk...';
        document.body.appendChild(notif);
        
        setTimeout(() => {
          notif.style.opacity = '0';
          setTimeout(() => notif.remove(), 500);
        }, 2000);
      }
    };

    /**
     * CORE APPLICATION
     */
    const app = {
      addToCart: () => {
        const qty = parseInt(elements.inputs.qty.value) || 1;

        if (!utils.validatePrice(selectedProduct.harga)) {
          Swal.fire({
            icon: 'error',
            title: 'Gagal',
            text: 'Harga produk tidak valid. Segarkan halaman dan coba lagi.',
            timer: 2000
          });
          return;
        }

        if (qty > 0 && selectedProduct) {
          const rule = utils.getWholesaleRule(selectedProduct.kategori);
          const totalQtyInCategory = utils.getTotalQtyByCategory(cart, selectedProduct.kategori) + qty;
          const isWholesale = totalQtyInCategory >= rule.minQty && utils.validatePrice(selectedProduct.harga_grosir);
          const price = isWholesale ? selectedProduct.harga_grosir : selectedProduct.harga;

          const existingItemIndex = cart.findIndex(item =>
            item.produk === selectedProduct.produk &&
            item.harga === price
          );

          if (existingItemIndex >= 0) {
            cart[existingItemIndex].qty += qty;
          } else {
            cart.push({
              ...selectedProduct,
              harga: price,
              qty: qty,
              isWholesale: isWholesale
            });
          }

          ui.updateCart();
          ui.hideModal();

          const notification = Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: `${qty} ${utils.formatProductName(selectedProduct.produk)} telah ditambahkan ke keranjang`,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 1500,
            timerProgressBar: true
          });
        }
      },

      removeFromCart: (index) => {
        cart.splice(index, 1);
        ui.updateCart();
      },

      processCheckout: async () => {
        const name = elements.inputs.customerName.value.trim();
        const address = elements.inputs.customerAddress.value.trim();
        const phone = elements.inputs.customerPhone.value.trim();

        if (!name || !address || !phone) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Harap lengkapi semua data pemesan!',
            timer: 2000,
            showConfirmButton: false
          });
          return;
        }

        if (!utils.validatePhone(phone)) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Nomor WhatsApp tidak valid! Harap masukkan 10-15 digit nomor.',
            timer: 2000,
            showConfirmButton: false
          });
          return;
        }

        localStorage.setItem('customerName', name);
        localStorage.setItem('customerAddress', address);
        localStorage.setItem('customerPhone', phone);

        customerData = { name, address, phone };

        const { message, total } = ui.generateOrderMessage();
        const whatsappUrl = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(message)}`;

        // Simpan transaksi ke Google Sheets
        const logSuccess = await dataService.logTransaction(customerData, cart, total);

        if (!logSuccess) {
          Swal.fire({
            icon: 'warning',
            title: 'Peringatan',
            text: 'Transaksi berhasil tapi gagal disimpan di database',
            timer: 2000
          });
        }

        window.open(whatsappUrl, '_blank');

        cart = [];
        ui.updateCart();
        elements.modals.customer.classList.remove('visible');

        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: 'Pesanan berhasil dibuat! Silahkan lanjutkan pembayaran via WhatsApp.',
          confirmButtonText: 'Oke',
          confirmButtonColor: '#008ca7'
        });
      },

      init: () => {
        elements.categoryFilter.addEventListener('change', () => {
          ui.updateBrandFilter();
          ui.renderProducts();
        });

        elements.brandFilter.addEventListener('change', ui.renderProducts);
        elements.productFilter.addEventListener('input', ui.renderProducts);

        elements.buttons.addToCart.addEventListener('click', app.addToCart);
        elements.buttons.closeModal.addEventListener('click', ui.hideModal);
        elements.checkoutBtn.addEventListener('click', ui.checkout);
        elements.buttons.confirmCustomer.addEventListener('click', app.processCheckout);
        elements.buttons.cancelCustomer.addEventListener('click', () => {
          elements.modals.customer.classList.remove('visible');
        });

        elements.cartIcon.addEventListener('click', ui.toggleCart);
        elements.closeCartBtn.addEventListener('click', ui.closeCart);

        window.removeFromCart = app.removeFromCart;
        
        // Load products and start auto-refresh
        dataService.loadProducts();
        dataService.startAutoRefresh();

        // Load saved customer data if exists
        const savedName = localStorage.getItem('customerName');
        if (savedName) {
          customerData.name = savedName;
          elements.inputs.customerName.value = savedName;
        }
      }
    };

    // Set timestamp
    const timestampElement = document.getElementById("timestamp");
    const now = new Date();
    const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    timestampElement.innerText = `Terakhir diperbarui: ${timestamp}`;

    // Start the application when DOM is ready
    document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>
</html>